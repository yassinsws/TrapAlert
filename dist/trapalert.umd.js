!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TrapAlert={})}(this,function(t){"use strict";class e{constructor(t=2){this.score=0,this.lastDecayTime=Date.now(),this.decayRate=t}setDecayRate(t){this.decayRate=t}add(t){return this.score=this.score+t,this.score}subtract(t){return this.score=Math.max(0,this.score-t),this.score}decay(){const t=Date.now(),e=(t-this.lastDecayTime)/1e3;if(e>=1){const i=e*this.decayRate;this.subtract(i),this.lastDecayTime=t}}get(){return this.score}reset(){this.score=0,this.lastDecayTime=Date.now()}}class i{constructor(t,e,i){this.shadowRoot=t,this.onReport=e,this.onDismiss=i,this.ariaLiveRegion=null,this.initialize()}initialize(){this.createAriaLiveRegion(),this.createSidebar()}createAriaLiveRegion(){this.ariaLiveRegion=document.createElement("div"),this.ariaLiveRegion.setAttribute("role","status"),this.ariaLiveRegion.setAttribute("aria-live","assertive"),this.ariaLiveRegion.setAttribute("aria-atomic","true"),this.ariaLiveRegion.style.cssText="\n      position: absolute;\n      left: -10000px;\n      width: 1px;\n      height: 1px;\n      overflow: hidden;\n    ",this.shadowRoot.appendChild(this.ariaLiveRegion)}createSidebar(){const t=document.createElement("style");t.textContent="\n      :host {\n        --ta-blue: #667eea;\n        --ta-purple: #764ba2;\n        --ta-sidebar-width: 350px;\n      }\n\n      .trapalert-sidebar {\n        position: fixed;\n        top: 0;\n        right: calc(var(--ta-sidebar-width) * -1);\n        width: var(--ta-sidebar-width);\n        height: 100vh;\n        background: linear-gradient(135deg, #1a1c2c 0%, #4a192c 100%);\n        box-shadow: -4px 0 30px rgba(0, 0, 0, 0.5);\n        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        z-index: 999999;\n        color: white;\n        font-family: 'Outfit', sans-serif;\n        display: flex;\n        flex-direction: column;\n        padding: 40px 30px;\n        box-sizing: border-box;\n        border-left: 1px solid rgba(255, 255, 255, 0.1);\n      }\n\n      .trapalert-sidebar.visible {\n        right: 0;\n      }\n\n      .trapalert-handle {\n        position: fixed;\n        right: 0;\n        top: 50%;\n        transform: translateY(-50%);\n        background: #1a1c2c;\n        color: white;\n        padding: 15px 8px;\n        border-radius: 8px 0 0 8px;\n        cursor: pointer;\n        writing-mode: vertical-rl;\n        text-orientation: mixed;\n        font-size: 12px;\n        font-weight: 600;\n        letter-spacing: 1px;\n        text-transform: uppercase;\n        border: 1px solid rgba(255,255,255,0.2);\n        border-right: none;\n        transition: padding 0.2s;\n        z-index: 999998;\n        box-shadow: -2px 0 10px rgba(0,0,0,0.3);\n      }\n\n      .trapalert-handle:hover {\n        padding-right: 15px;\n        background: #2a2c3c;\n      }\n\n      .trapalert-header {\n        font-size: 24px;\n        font-weight: 700;\n        margin-bottom: 20px;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n      }\n\n      .trapalert-icon {\n        width: 36px;\n        height: 36px;\n        background: rgba(255, 255, 255, 0.1);\n        border-radius: 10px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 22px;\n      }\n\n      .trapalert-message {\n        font-size: 15px;\n        line-height: 1.6;\n        margin-bottom: 30px;\n        color: rgba(255, 255, 255, 0.8);\n      }\n\n      .trapalert-score {\n        background: rgba(0, 0, 0, 0.3);\n        padding: 20px;\n        border-radius: 12px;\n        margin-bottom: 25px;\n        border: 1px solid rgba(255, 255, 255, 0.05);\n      }\n\n      .trapalert-score-label {\n        font-size: 11px;\n        text-transform: uppercase;\n        letter-spacing: 1.5px;\n        opacity: 0.6;\n        margin-bottom: 8px;\n      }\n\n      .trapalert-score-value {\n        font-size: 42px;\n        font-weight: 800;\n        background: linear-gradient(to right, #fff, #aab);\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n      }\n\n      .trapalert-button {\n        background: white;\n        color: #1a1c2c;\n        border: none;\n        padding: 16px 24px;\n        border-radius: 10px;\n        font-size: 15px;\n        font-weight: 700;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        margin-bottom: 12px;\n      }\n\n      .trapalert-button:hover {\n        background: #f0f0f0;\n        transform: translateY(-2px);\n      }\n\n      .trapalert-button-secondary {\n        background: rgba(255, 255, 255, 0.1);\n        color: white;\n        border: 1px solid rgba(255, 255, 255, 0.1);\n      }\n\n      .trapalert-button-secondary:hover {\n        background: rgba(255, 255, 255, 0.15);\n      }\n\n      .trapalert-close {\n        position: absolute;\n        top: 20px;\n        right: 20px;\n        background: rgba(255, 255, 255, 0.05);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        color: white;\n        width: 32px;\n        height: 32px;\n        border-radius: 50%;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s;\n      }\n\n      .trapalert-close:hover {\n        background: rgba(255, 255, 255, 0.2);\n        transform: rotate(90deg);\n      }\n\n      .trapalert-timer {\n        font-family: monospace;\n        font-size: 28px;\n        color: #ff4d4d;\n        font-weight: 800;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        margin: 20px 0;\n      }\n\n      .trapalert-timer::before {\n        content: '';\n        width: 14px;\n        height: 14px;\n        background: #ff4d4d;\n        border-radius: 50%;\n        animation: ta-pulse 1s infinite;\n      }\n\n      @keyframes ta-pulse {\n        0% { opacity: 1; transform: scale(1); }\n        50% { opacity: 0.4; transform: scale(1.2); }\n        100% { opacity: 1; transform: scale(1); }\n      }\n\n\n\n      .trapalert-input {\n        width: 100%;\n        background: rgba(0, 0, 0, 0.3);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        border-radius: 8px;\n        padding: 12px;\n        margin-bottom: 15px;\n        color: white;\n        font-family: inherit;\n        font-size: 14px;\n        resize: vertical;\n        box-sizing: border-box;\n      }\n\n      .trapalert-input:focus {\n        outline: none;\n        border-color: var(--ta-blue);\n        background: rgba(0, 0, 0, 0.5);\n      }\n    ",this.shadowRoot.appendChild(t);const e=document.createElement("button");e.className="trapalert-handle",e.id="ta-handle",e.setAttribute("aria-label","Open TrapAlert Reporting Tool"),e.textContent="Report Barrier",this.shadowRoot.appendChild(e);const i=document.createElement("aside");i.className="trapalert-sidebar",i.setAttribute("role","complementary"),i.setAttribute("aria-label","TrapAlert Accessibility Tool"),i.innerHTML='\n      <button class="trapalert-close" id="ta-close" aria-label="Close TrapAlert">√ó</button>\n      <div class="trapalert-header">\n        <div class="trapalert-icon">üõ°Ô∏è</div>\n        <span>TrapAlert</span>\n      </div>\n\n      \x3c!-- Idle UI --\x3e\n      <div id="idle-ui" style="display: flex; flex-direction: column;">\n        <div class="trapalert-message">\n          We\'ve detected potential navigation barriers. Help us improve the experience for everyone.\n        </div>\n\n\n        <textarea id="issue-description" class="trapalert-input" rows="3" placeholder="Describe the issue (optional)..."></textarea>\n\n        <button class="trapalert-button" id="start-recording-btn">\n          üé• Record Feedback (Voice + Screen)\n        </button>\n        <button class="trapalert-button trapalert-button-secondary" id="dismiss-btn">\n          Keep Browsing\n        </button>\n      </div>\n\n      \x3c!-- Recording UI --\x3e\n      <div id="recording-ui" style="display: none; flex-direction: column; align-items: center;">\n        <div class="trapalert-timer" id="recording-timer">00:00</div>\n        <div class="trapalert-message" style="text-align: center; margin-top: 10px;">\n           Recording in progress...\n        </div>\n        <button class="trapalert-button" id="stop-recording-btn" style="background: #ff4d4d; color: white; width: 100%; margin-top: 20px;">\n          ‚èπÔ∏è Stop and Send\n        </button>\n      </div>\n\n      \x3c!-- Uploading UI --\x3e\n      <div id="uploading-ui" style="display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%;">\n        <div class="trapalert-icon" style="width: 60px; height: 60px; font-size: 40px; margin-bottom: 20px;">‚è≥</div>\n        <div class="trapalert-header" style="justify-content: center;">\n            <span>Finalizing...</span>\n        </div>\n        <div class="trapalert-message" style="text-align: center;">\n           Securely packaging your screen recording and DOM snapshot.\n        </div>\n      </div>\n    ',this.shadowRoot.appendChild(i),this.bindEvents()}bindEvents(){const t=this.shadowRoot.querySelector("#ta-handle"),e=this.shadowRoot.querySelector("#ta-close"),i=this.shadowRoot.querySelector("#dismiss-btn"),n=this.shadowRoot.querySelector("#start-recording-btn"),r=this.shadowRoot.querySelector("#stop-recording-btn");t.addEventListener("click",()=>this.show()),e.addEventListener("click",()=>this.hide()),i.addEventListener("click",()=>{this.hide(),this.onDismiss()}),n.addEventListener("click",()=>{this.onStartRecording&&this.onStartRecording()}),r.addEventListener("click",()=>{this.onStopRecording&&this.onStopRecording()})}setRecordingState(t){const e=this.shadowRoot.querySelector("#idle-ui"),i=this.shadowRoot.querySelector("#recording-ui"),n=this.shadowRoot.querySelector("#uploading-ui");e&&(e.style.display="idle"===t?"flex":"none"),i&&(i.style.display="recording"===t?"flex":"none"),n&&(n.style.display="uploading"===t?"flex":"none"),"recording"===t?this.startTimer():this.stopTimer()}startTimer(){let t=0;const e=this.shadowRoot.querySelector("#recording-timer");this.timerInterval&&clearInterval(this.timerInterval),this.timerInterval=setInterval(()=>{t++;const i=Math.floor(t/60).toString().padStart(2,"0"),n=(t%60).toString().padStart(2,"0");e&&(e.textContent=`${i}:${n}`)},1e3)}stopTimer(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)}show(t){const e=this.shadowRoot.querySelector(".trapalert-sidebar"),i=this.shadowRoot.querySelector("#ta-handle");e&&(this.setRecordingState("idle"),e.classList.add("visible"),i&&(i.style.display="none"),document.body.classList.add("trapalert-open"),setTimeout(()=>{const t=this.shadowRoot.querySelector("#ta-close");t&&t.focus()},300),this.announce("TrapAlert: Accessibility barrier detected. Sidebar opened."))}hide(){const t=this.shadowRoot.querySelector(".trapalert-sidebar"),e=this.shadowRoot.querySelector("#ta-handle");t&&(this.stopTimer(),t.classList.remove("visible"),e&&(e.style.display="block"),document.body.classList.remove("trapalert-open"))}announce(t){this.ariaLiveRegion&&(this.ariaLiveRegion.textContent=t)}updateMessage(t){this.announce(t);const e=this.shadowRoot.querySelector(".trapalert-message");e&&(e.textContent=t)}getDescription(){const t=this.shadowRoot.querySelector("#issue-description");return t?t.value:""}}function n(t){if(!t||t===document)return"document";if(t===window)return"window";if(t.id)return`#${t.id}`;if(t.className&&"string"==typeof t.className){const e=t.className.trim().split(/\s+/).join(".");if(e)return`${t.tagName.toLowerCase()}.${e}`}return t.tagName.toLowerCase()}function r(t){if(""!==t.id)return`//*[@id="${t.id}"]`;if(t===document.body)return"/html/body";let e=0;const i=t.parentNode?t.parentNode.childNodes:[];for(let n=0;n<i.length;n++){const s=i[n];if(s===t)return r(t.parentNode)+"/"+t.tagName.toLowerCase()+"["+(e+1)+"]";1===s.nodeType&&s.tagName===t.tagName&&e++}return""}class s{constructor(t){this.struggleScore=t,this.focusBuffer=[],this.maxFocusBuffer=20,this.navigationHistory=[],this.maxNavHistory=10,this.clickHistory=new Map,this.tabCount=0,this.lastProductiveAction=Date.now(),this.currentInputObj=null,this.momentumEndsAt=0,this.sensitivityMultiplier=1,this.sensitivityEndsAt=0,this.interactedElements=new Set,this.focusClusterBuffer=[]}addScore(t,e){const i=Date.now();let n=t;this.onTrigger&&this.onTrigger(),i<this.sensitivityEndsAt&&(n*=this.sensitivityMultiplier);const r=t>=60||"Rage Click"===e;i<this.momentumEndsAt&&!r&&(n*=.2),n=Math.round(n),n>0&&(console.log(`[BehaviorEngine] Adding ${n} points (${e}). Base: ${t}, Sens: ${this.sensitivityMultiplier}, Mom: ${i<this.momentumEndsAt}`),this.struggleScore.add(n))}registerSuccess(){this.momentumEndsAt=Date.now()+5e3,this.resetDeadEndTab(),this.uTurnCounter=0,this.struggleScore.setDecayRate(10),this.struggleScore.subtract(10),this.decayRevertTimeout&&clearTimeout(this.decayRevertTimeout),this.decayRevertTimeout=setTimeout(()=>{this.struggleScore.setDecayRate(2)},5e3)}registerContextShift(t=!1){this.momentumEndsAt=0,this.uTurnCounter=0,this.sensitivityMultiplier=2,this.sensitivityEndsAt=Date.now()+3e4,console.log(`[BehaviorEngine] Context Shift! Sensitivity doubled. Submit: ${t}`)}handleFocus(t){const e=n(t),i=r(t),s=t.id||null,o=Date.now();if(this.pruneHistory(o),this.interactedElements.has(e))return;this.focusBuffer.push({id:s,xpath:i,timestamp:o}),this.focusBuffer.length>this.maxFocusBuffer&&this.focusBuffer.shift();const a=t.getBoundingClientRect();this.focusClusterBuffer.push({x:a.left,y:a.top,selector:e,timestamp:o}),this.focusClusterBuffer.length>5&&this.focusClusterBuffer.shift(),this.detectClusterLoop(),this.evaluateEfficiency(),this.navigationHistory.push(e),this.navigationHistory.length>this.maxNavHistory&&this.navigationHistory.shift(),this.detectUTurn()}pruneHistory(t){this.focusBuffer=this.focusBuffer.filter(e=>t-e.timestamp<6e4),this.focusClusterBuffer=this.focusClusterBuffer.filter(e=>t-e.timestamp<6e4)}detectClusterLoop(){if(this.focusClusterBuffer.length<5)return;const t=this.focusClusterBuffer.map(t=>t.x),e=this.focusClusterBuffer.map(t=>t.y),i=Math.min(...t),n=Math.max(...t),r=Math.min(...e),s=Math.max(...e);if(n-i<300&&s-r<300){const t=this.focusClusterBuffer.map(t=>t.selector);new Set(t).size<3&&(console.log("[BehaviorEngine] Localized Trap (Cluster) detected"),this.addScore(10,"Localized Trap"))}}evaluateEfficiency(){const t=this.focusBuffer.length;if(t<8)return;const e=new Set(this.focusBuffer.map(t=>t.id||t.xpath)).size/t;e<.25?this.addScore(5,"Low Efficiency"):e>.8&&(this.resetDeadEndTab(),this.struggleScore.get()>0&&this.struggleScore.subtract(20))}detectUTurn(){if(this.navigationHistory.length<5)return;const t=this.navigationHistory,e=t.length,i=t[e-5],n=t[e-4],r=t[e-3],s=t[e-2];i===t[e-1]&&n===s&&i!==n&&n!==r&&(this.uTurnCounter=(this.uTurnCounter||0)+1,this.uTurnCounter>1?(console.log("[BehaviorEngine] Repeated U-Turn detected"),this.addScore(20,"Repeated U-Turn")):(console.log("[BehaviorEngine] Intentional U-Turn (Normalization)"),this.addScore(5,"Minor Backtrack")),this.navigationHistory=[])}handleClick(t){const e=n(t),i=Date.now(),r=function(t){try{return"pointer"===window.getComputedStyle(t).cursor}catch(e){return!1}}(t),s=["a","button","input","select","textarea"].includes(t.tagName.toLowerCase())||t.hasAttribute("onclick")||"button"===t.getAttribute("role");(s||r)&&(this.pendingSuccess={timestamp:i,type:"click",selector:e},setTimeout(()=>{this.pendingSuccess&&this.pendingSuccess.timestamp===i&&(this.pendingSuccess=null)},1e3)),["input","textarea","select"].includes(t.tagName.toLowerCase())&&this.interactedElements.add(e),"submit"!==t.getAttribute("type")&&"button"!==t.getAttribute("role")||this.registerContextShift(!0),this.clickHistory.has(e)||this.clickHistory.set(e,[]);const o=this.clickHistory.get(e);o.push(i);const a=o.filter(t=>i-t<2e3);this.clickHistory.set(e,a),a.length>5&&(r||s?(console.log("[BehaviorEngine] Potential Broken Button / Dead-End Click sequence"),this.addScore(40,"Button Mashing"),this.clickHistory.delete(e)):(this.addScore(60,"Rage Click (Static)"),this.clickHistory.delete(e)))}registerMutation(){this.pendingSuccess&&(console.log(`[BehaviorEngine] Click on ${this.pendingSuccess.selector} verified by DOM mutation. Registering Success.`),this.registerSuccess(),this.pendingSuccess=null)}handleTab(){this.tabCount++,this.tabCount>15&&(this.addScore(40,"Dead-End Tab"),this.tabCount=0)}resetDeadEndTab(){this.tabCount=0}handleInputFocus(t){"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName||(this.currentInputObj={element:t,startValue:t.value,maxLenReached:t.value.length,typed:!1})}handleInputType(t){this.registerSuccess(),this.currentInputObj&&this.currentInputObj.element===t&&(this.currentInputObj.typed=!0,this.interactedElements.add(n(t)),t.value.length>this.currentInputObj.maxLenReached&&(this.currentInputObj.maxLenReached=t.value.length))}handleInputBlur(t){if(this.currentInputObj&&this.currentInputObj.element===t){const e=t.value.length,i=this.currentInputObj.startValue.length,n=this.currentInputObj.maxLenReached-i;this.currentInputObj.typed&&(n>0&&n<3)&&e<=i&&this.addScore(20,"Input Abandonment"),this.currentInputObj=null}}}function o(){const t=document.cloneNode(!0),e=t.documentElement,i=window.location.href;["src","href"].forEach(t=>{e.querySelectorAll(`[${t}]`).forEach(e=>{const n=e.getAttribute(t);if(n&&!n.startsWith("http")&&!n.startsWith("data:")&&!n.startsWith("//"))try{e.setAttribute(t,new URL(n,i).href)}catch(r){}})});const n=document.querySelectorAll("*"),r=e.querySelectorAll("*");return n.forEach((e,i)=>{const n=r[i];if(n){if("INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName||(n.value=e.value),"CANVAS"===e.tagName){const i=t.createElement("img");i.src=e.toDataURL(),i.style.cssText=e.style.cssText,n.replaceWith(i)}e.scrollTop>0&&n.setAttribute("data-ta-scroll-top",e.scrollTop),e.scrollLeft>0&&n.setAttribute("data-ta-scroll-left",e.scrollLeft)}}),e.outerHTML}class a{constructor(t){if(!t||!t.tenantId||!t.collectorEndpoint)throw new Error("TrapAlert requires tenantId and collectorEndpoint");this.tenantId=t.tenantId,this.collectorEndpoint=t.collectorEndpoint.replace(/\/+$/,""),this.struggleScore=new e,this.behavioralTrace=[],this.maxTraceLength=20,this.behaviorEngine=new s(this.struggleScore),this.behaviorEngine.onTrigger=()=>{this.lastTriggerTime=Date.now()},this.mediaRecorder=null,this.recordedChunks=[],this.domSnapshot=null,this.triggerSnapshot=null,this.domSnapshot=null,this.triggerSnapshot=null,this.audioContext=null,this.focusHistory=[],this.escPressHistory=[],this.lastProductiveTime=Date.now(),this.startTime=Date.now(),this.lastTriggerTime=Date.now(),this.activationThreshold=100,this.triggerLevel=0,this.notificationShown=!1,this.ui=null,this.init()}init(){this.setupUI(),this.attachListeners(),this.startDecayTimer(),this.startVelocityGateMonitor(),console.log(`[TrapAlert] Initialized for tenant: ${this.tenantId}`)}startVelocityGateMonitor(){setInterval(()=>{const t=Date.now(),e=t-this.startTime,i=t-this.lastTriggerTime;e>6e5&&i>6e5&&100===this.activationThreshold&&(this.activationThreshold=120,console.log("[TrapAlert] Velocity Gate: Increasing threshold to 120 for happy user."))},6e4)}setupUI(){const t=document.createElement("style");t.textContent="\n            body.trapalert-open {\n                margin-right: 350px;\n                transition: margin 0.3s ease;\n                overflow-x: hidden;\n            }\n            .ta-skip-link {\n                position: absolute;\n                top: -100px;\n                left: 0;\n                background: #1a1c2c;\n                color: white;\n                padding: 15px 25px;\n                z-index: 1000000;\n                text-decoration: none;\n                font-weight: bold;\n                border-bottom: 2px solid #fff;\n                transition: top 0.2s;\n            }\n            .ta-skip-link:focus {\n                top: 0;\n            }\n        ",document.head.appendChild(t);const e=document.createElement("a");e.href="#",e.className="ta-skip-link",e.textContent="Skip to Report Accessibility Issue with TrapAlert",e.addEventListener("click",t=>{t.preventDefault(),this.ui.show(this.struggleScore.get())}),document.body.prepend(e);const n=document.createElement("div");n.id="trapalert-container",n.setAttribute("aria-hidden","false"),document.body.appendChild(n);const r=n.attachShadow({mode:"open"});this.ui=new i(r,()=>this.handleReport(),()=>this.handleDismiss()),this.ui.onStartRecording=this.handleStartRecording.bind(this),this.ui.onStopRecording=this.handleStopRecording.bind(this)}async handleStartRecording(){try{let i;try{i=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0})}catch(t){throw console.error("[TrapAlert] Screen recording permission denied or cancelled:",t),new Error(`Screen recording permission denied: ${t.message}`)}this.triggerSnapshot?(this.domSnapshot=this.triggerSnapshot,console.log("[TrapAlert] Using Contextual DOM Snapshot (from trigger moment).")):(this.domSnapshot=o(),console.log("[TrapAlert] Captured fresh DOM Snapshot (no trigger context found)."));let n=i,r=null;try{r=await navigator.mediaDevices.getUserMedia({audio:!0}),console.log("[TrapAlert] Microphone access granted.")}catch(t){console.warn("[TrapAlert] Microphone access denied or not available:",t)}try{this.audioContext=new(window.AudioContext||window.webkitAudioContext);const t=this.audioContext.createMediaStreamDestination();let e=!1;if(i.getAudioTracks().length>0){this.audioContext.createMediaStreamSource(i).connect(t),console.log("[TrapAlert] Audio Mixing: Connected System Audio"),e=!0}if(r&&r.getAudioTracks().length>0){this.audioContext.createMediaStreamSource(r).connect(t),console.log("[TrapAlert] Audio Mixing: Connected Microphone"),e=!0}const s=t.stream.getAudioTracks(),o=[...i.getVideoTracks(),...e?s:[]];console.log(`[TrapAlert] Stream tracks: ${o.length} (Video: ${i.getVideoTracks().length}, Audio: ${e?1:0})`),n=new MediaStream(o)}catch(e){console.error("[TrapAlert] Audio Context Error:",e);const t=[...i.getVideoTracks(),...i.getAudioTracks(),...r?r.getAudioTracks():[]];n=new MediaStream(t)}this.recordedChunks=[];const s=["video/webm;codecs=vp9,opus","video/webm;codecs=vp8,opus","video/webm","video/mp4"];let a="";for(const t of s)if(MediaRecorder.isTypeSupported(t)){a=t;break}console.log(`[TrapAlert] Using MIME type: ${a||"default"}`);const c=a?{mimeType:a}:{};this.mediaRecorder=new MediaRecorder(n,c),this.mediaRecorder.ondataavailable=t=>{t.data.size>0&&this.recordedChunks.push(t.data)},this.mediaRecorder.onstop=()=>{this.finalizeRecording(),n.getTracks().forEach(t=>t.stop())},this.mediaRecorder.start(),this.ui.setRecordingState("recording"),console.log("[TrapAlert] Recording started.")}catch(t){console.error("[TrapAlert] Failed to start recording:",t),alert("Feedback Recording Error: Please ensure you grant Screen and Microphone permissions.")}}handleStopRecording(){this.mediaRecorder&&"inactive"!==this.mediaRecorder.state&&(this.mediaRecorder.stop(),this.ui.setRecordingState("uploading")),this.audioContext&&(this.audioContext.close(),this.audioContext=null)}async finalizeRecording(){const t=new Blob(this.recordedChunks,{type:"video/webm"}),e=new FormData;e.append("video",t,"feedback-recording.webm"),e.append("dom",this.domSnapshot),e.append("metadata",JSON.stringify(this.getBrowserMetadata())),e.append("struggleScore",this.struggleScore.get()),e.append("description",this.ui.getDescription()),e.append("tenantId",this.tenantId),console.log(e.get("transcript")),console.log("[TrapAlert] Dispatching multi-modal feedback..."),console.log("[TrapAlert] Payload details:");for(let[n,r]of e.entries())r instanceof Blob?console.log(`- ${n}: Binary Blob (${r.size} bytes, type: ${r.type})`):console.log(`- ${n}: ${String(r).substring(0,100)}${String(r).length>100?"...":""}`);try{if(!(await fetch(`${this.collectorEndpoint}/feedback`,{method:"POST",body:e})).ok)throw new Error("Upload failed");console.log("[TrapAlert] Feedback uploaded successfully."),this.ui.updateMessage("Feedback sent! Our engineers will audit this snapshot immediately.")}catch(i){console.error("[TrapAlert] Feedback upload failed:",i),this.ui.updateMessage("Something went wrong during upload. Please try again.")}finally{setTimeout(()=>{this.ui.setRecordingState("idle"),this.struggleScore.reset(),this.domSnapshot=null,this.triggerSnapshot=null},3e3)}}attachListeners(){window.addEventListener("focusin",this.handleFocusIn.bind(this),!0),window.addEventListener("focusout",this.handleFocusOut.bind(this),!0),window.addEventListener("keydown",this.handleKeyDown.bind(this),!0),window.addEventListener("click",this.handleClick.bind(this),!0),window.addEventListener("input",this.handleInput.bind(this),!0),window.addEventListener("keydown",this.handleShortcut.bind(this),!0),this.observer=new MutationObserver(this.handleMutations.bind(this)),this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["role","aria-live","class","style"]}),window.addEventListener("visibilitychange",()=>{document.hidden&&(console.log("[TrapAlert] Tab hidden - resetting frustration engine"),this.struggleScore.reset(),this.triggerLevel=0,this.behaviorEngine.resetDeadEndTab())})}handleMutations(t){t.length>0&&this.behaviorEngine.registerMutation();for(const e of t)"childList"===e.type?e.addedNodes.forEach(t=>{1===t.nodeType&&this.checkErrorNode(t)}):"attributes"===e.type&&this.checkErrorNode(e.target)}checkErrorNode(t){if(!t.getAttribute)return;const e=t.getAttribute("role"),i=t.getAttribute("aria-live");("alert"===e||"assertive"===i||t.className&&"string"==typeof t.className&&t.className.toLowerCase().includes("error"))&&(console.log("[TrapAlert] Error message detected (DOM Mutation)"),this.behaviorEngine.registerContextShift(!1))}handleFocusIn(t){const e=t.target,i=n(e),r=Date.now();this.addToTrace("focusin",i),this.focusHistory.push({element:e,selector:i,timestamp:r}),this.focusHistory=this.focusHistory.filter(t=>r-t.timestamp<6e4),this.focusHistory.length>20&&this.focusHistory.shift(),this.behaviorEngine.handleFocus(e),this.behaviorEngine.handleInputFocus(e),this.checkThreshold()}handleFocusOut(t){this.behaviorEngine.handleInputBlur(t.target),this.checkThreshold()}handleKeyDown(t){this.addToTrace("keydown",t.key),"Tab"===t.key&&(this.behaviorEngine.handleTab(),this.checkThreshold()),"Escape"===t.key&&this.handleEscapePress()}handleEscapePress(){const t=Date.now();this.escPressHistory.push(t),this.escPressHistory=this.escPressHistory.filter(e=>t-e<3e3),this.escPressHistory.length>=3&&(console.log("[TrapAlert] Rapid Escape presses detected"),this.struggleScore.add(50),this.checkThreshold(),this.escPressHistory=[])}handleClick(t){const e=t.target,i=n(e);this.addToTrace("click",i),this.markProductiveBehavior(),this.behaviorEngine.handleClick(e),this.checkThreshold()}handleInput(t){this.addToTrace("input",n(t.target)),this.markProductiveBehavior(),this.behaviorEngine.handleInputType(t.target)}markProductiveBehavior(){this.lastProductiveTime=Date.now(),this.behaviorEngine.resetDeadEndTab()}handleShortcut(t){t.altKey&&"t"===t.key&&(t.preventDefault(),this.triggerSnapshot=o(),console.log("[TrapAlert] Manual invocation: Contextual DOM Snapshot captured."),this.ui.show(this.struggleScore.get()))}startDecayTimer(){setInterval(()=>{this.struggleScore.decay(),this.notificationShown&&this.ui.updateScore(this.struggleScore.get())},1e3)}addToTrace(t,e){this.behavioralTrace.push({type:t,detail:e,timestamp:Date.now(),url:window.location.href}),this.behavioralTrace.length>this.maxTraceLength&&this.behavioralTrace.shift()}checkThreshold(){const t=this.struggleScore.get(),e=this.activationThreshold,i=2*e;0===this.triggerLevel&&t>=e?(console.log(`[TrapAlert] Level 1 Trigger (Score: ${t}, Threshold: ${e})`),this.triggerSnapshot||(this.triggerSnapshot=o(),console.log("[TrapAlert] Level 1 Trigger: Contextual DOM Snapshot captured.")),this.triggerLevel=1,this.notifyUser()):1===this.triggerLevel&&t>=i&&(console.log(`[TrapAlert] Level 2 Escalation (Score: ${t}, Threshold: ${i})`),this.triggerLevel=2,this.notifyUser()),t<10&&0!==this.triggerLevel&&(this.triggerLevel=0)}notifyUser(){this.notificationShown||(this.notificationShown=!0,this.ui.show(this.struggleScore.get()))}handleDismiss(){this.notificationShown=!1}handleReport(){this.dispatchReport(),this.notificationShown=!1,this.struggleScore.reset(),this.notificationShown=!1,this.struggleScore.reset(),this.triggerLevel=0,this.triggerSnapshot=null}dispatchReport(){const t={tenantId:this.tenantId,timestamp:(new Date).toISOString(),url:window.location.href,struggleScore:this.struggleScore.get(),description:this.ui.getDescription(),behavioralTrace:this.behavioralTrace,context:this.captureContext(),metadata:this.getBrowserMetadata()};if(console.log("[TrapAlert] Dispatching report:",t),navigator.sendBeacon){const e=new Blob([JSON.stringify(t)],{type:"application/json"});navigator.sendBeacon(this.collectorEndpoint,e)||this.fallbackFetch(t)}else this.fallbackFetch(t)}fallbackFetch(t){fetch(this.collectorEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),keepalive:!0}).catch(t=>{console.error("[TrapAlert] Failed to send report:",t)})}captureContext(){const t=document.activeElement;return{activeElement:{selector:n(t),outerHTML:t?t.outerHTML:null,tagName:t?t.tagName:null,role:t?t.getAttribute("role"):null},focusHistory:this.focusHistory.map(t=>({selector:t.selector,timestamp:t.timestamp})),pageTitle:document.title,scrollPosition:{x:window.scrollX,y:window.scrollY}}}getBrowserMetadata(){return{userAgent:navigator.userAgent,screenSize:{width:window.screen.width,height:window.screen.height},viewportSize:{width:window.innerWidth,height:window.innerHeight},language:navigator.language,platform:navigator.platform,timestamp:Date.now()}}}"undefined"!=typeof window&&(window.TrapAlert={init:t=>new a(t)}),t.TrapAlert=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=trapalert.umd.js.map
