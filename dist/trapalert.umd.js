!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TrapAlert={})}(this,function(t){"use strict";class e{constructor(t=2){this.score=0,this.lastDecayTime=Date.now(),this.decayRate=t}setDecayRate(t){this.decayRate=t}add(t){return this.score=this.score+t,this.score}subtract(t){return this.score=Math.max(0,this.score-t),this.score}decay(){const t=Date.now(),e=(t-this.lastDecayTime)/1e3;if(e>=1){const i=e*this.decayRate;this.subtract(i),this.lastDecayTime=t}}get(){return this.score}reset(){this.score=0,this.lastDecayTime=Date.now()}}class i{constructor(t,e,i){this.shadowRoot=t,this.onReport=e,this.onDismiss=i,this.ariaLiveRegion=null,this.initialize()}initialize(){this.createAriaLiveRegion(),this.createSidebar()}createAriaLiveRegion(){this.ariaLiveRegion=document.createElement("div"),this.ariaLiveRegion.setAttribute("role","status"),this.ariaLiveRegion.setAttribute("aria-live","assertive"),this.ariaLiveRegion.setAttribute("aria-atomic","true"),this.ariaLiveRegion.style.cssText="\n      position: absolute;\n      left: -10000px;\n      width: 1px;\n      height: 1px;\n      overflow: hidden;\n    ",this.shadowRoot.appendChild(this.ariaLiveRegion)}createSidebar(){const t=document.createElement("style");t.textContent="\n      .trapalert-sidebar {\n        position: fixed;\n        top: 0;\n        right: -400px;\n        width: 350px;\n        height: 100vh;\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);\n        transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n        z-index: 999999;\n        color: white;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;\n        display: flex;\n        flex-direction: column;\n        padding: 30px 25px;\n        box-sizing: border-box;\n      }\n\n      .trapalert-sidebar.visible {\n        right: 0;\n      }\n\n      .trapalert-header {\n        font-size: 24px;\n        font-weight: 700;\n        margin-bottom: 15px;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n      }\n\n      .trapalert-icon {\n        width: 32px;\n        height: 32px;\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 8px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 20px;\n      }\n\n      .trapalert-message {\n        font-size: 16px;\n        line-height: 1.6;\n        margin-bottom: 25px;\n        opacity: 0.95;\n      }\n\n      .trapalert-score {\n        background: rgba(255, 255, 255, 0.15);\n        padding: 15px;\n        border-radius: 10px;\n        margin-bottom: 20px;\n        backdrop-filter: blur(10px);\n      }\n\n      .trapalert-score-label {\n        font-size: 12px;\n        text-transform: uppercase;\n        letter-spacing: 1px;\n        opacity: 0.8;\n        margin-bottom: 5px;\n      }\n\n      .trapalert-score-value {\n        font-size: 36px;\n        font-weight: 700;\n      }\n\n      .trapalert-button {\n        background: white;\n        color: #667eea;\n        border: none;\n        padding: 14px 24px;\n        border-radius: 8px;\n        font-size: 16px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s;\n        margin-bottom: 10px;\n      }\n\n      .trapalert-button:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n      }\n\n      .trapalert-button:active {\n        transform: translateY(0);\n      }\n\n      .trapalert-button-secondary {\n        background: transparent;\n        color: white;\n        border: 2px solid rgba(255, 255, 255, 0.3);\n      }\n\n      .trapalert-close {\n        position: absolute;\n        top: 20px;\n        right: 20px;\n        background: rgba(255, 255, 255, 0.2);\n        border: none;\n        color: white;\n        width: 32px;\n        height: 32px;\n        border-radius: 50%;\n        cursor: pointer;\n        font-size: 20px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: background 0.2s;\n      }\n\n      .trapalert-close:hover {\n        background: rgba(255, 255, 255, 0.3);\n      }\n    ",this.shadowRoot.appendChild(t);const e=document.createElement("div");e.className="trapalert-sidebar",e.innerHTML='\n      <button class="trapalert-close" aria-label="Close notification">×</button>\n      <div class="trapalert-header">\n        <div class="trapalert-icon">⚠️</div>\n        <span>TrapAlert</span>\n      </div>\n      <div class="trapalert-message">\n        We\'ve detected potential accessibility barriers on this page. Your feedback helps make the web better for everyone.\n      </div>\n      <div class="trapalert-score">\n        <div class="trapalert-score-label">Frustration Score</div>\n        <div class="trapalert-score-value" id="score-display">0</div>\n      </div>\n      <button class="trapalert-button" id="report-btn">\n        Report Accessibility Issue\n      </button>\n      <button class="trapalert-button trapalert-button-secondary" id="dismiss-btn">\n        Dismiss\n      </button>\n    ',this.shadowRoot.appendChild(e),this.bindEvents()}bindEvents(){const t=this.shadowRoot.querySelector(".trapalert-close"),e=this.shadowRoot.querySelector("#report-btn"),i=this.shadowRoot.querySelector("#dismiss-btn");t.addEventListener("click",()=>this.hide()),i.addEventListener("click",()=>{this.hide(),this.onDismiss()}),e.addEventListener("click",()=>{this.onReport(),this.updateMessage("Thank you for reporting. Your feedback helps improve accessibility.")})}show(t){const e=this.shadowRoot.querySelector(".trapalert-sidebar");e&&(this.updateScore(t),e.classList.add("visible"),this.playNotificationSound(),this.announce("TrapAlert: Accessibility barrier detected. Press Alt+T to report."))}hide(){const t=this.shadowRoot.querySelector(".trapalert-sidebar");t&&t.classList.remove("visible")}updateScore(t){const e=this.shadowRoot.querySelector("#score-display");e&&(e.textContent=Math.round(t))}announce(t){this.ariaLiveRegion&&(this.ariaLiveRegion.textContent=t)}updateMessage(t){this.announce(t);const e=this.shadowRoot.querySelector(".trapalert-message");e&&(e.textContent=t)}playNotificationSound(){try{const t=new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6foKGio6SlpqeoqaqrrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfY2drb3N3e3+Dh4uPk5ebn6Onq6+zt7u/w8fLz9PX29/j5+vv8/f7/AAECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w==");t.volume=.3,t.play().catch(t=>{console.warn("[TrapAlert] Could not play notification sound:",t)})}catch(t){console.warn("[TrapAlert] Audio not supported:",t)}}}function s(t){if(!t||t===document)return"document";if(t===window)return"window";if(t.id)return`#${t.id}`;if(t.className&&"string"==typeof t.className){const e=t.className.trim().split(/\s+/).join(".");if(e)return`${t.tagName.toLowerCase()}.${e}`}return t.tagName.toLowerCase()}function n(t){if(""!==t.id)return`//*[@id="${t.id}"]`;if(t===document.body)return"/html/body";let e=0;const i=t.parentNode?t.parentNode.childNodes:[];for(let s=0;s<i.length;s++){const r=i[s];if(r===t)return n(t.parentNode)+"/"+t.tagName.toLowerCase()+"["+(e+1)+"]";1===r.nodeType&&r.tagName===t.tagName&&e++}return""}class r{constructor(t){this.struggleScore=t,this.focusBuffer=[],this.maxFocusBuffer=20,this.navigationHistory=[],this.maxNavHistory=10,this.clickHistory=new Map,this.tabCount=0,this.lastProductiveAction=Date.now(),this.currentInputObj=null,this.momentumEndsAt=0,this.sensitivityMultiplier=1,this.sensitivityEndsAt=0,this.interactedElements=new Set,this.focusClusterBuffer=[]}addScore(t,e){const i=Date.now();let s=t;this.onTrigger&&this.onTrigger(),i<this.sensitivityEndsAt&&(s*=this.sensitivityMultiplier);const n=t>=60||"Rage Click"===e;i<this.momentumEndsAt&&!n&&(s*=.2),s=Math.round(s),s>0&&(console.log(`[BehaviorEngine] Adding ${s} points (${e}). Base: ${t}, Sens: ${this.sensitivityMultiplier}, Mom: ${i<this.momentumEndsAt}`),this.struggleScore.add(s))}registerSuccess(){this.momentumEndsAt=Date.now()+5e3,this.resetDeadEndTab(),this.uTurnCounter=0,this.struggleScore.setDecayRate(10),this.struggleScore.subtract(10),this.decayRevertTimeout&&clearTimeout(this.decayRevertTimeout),this.decayRevertTimeout=setTimeout(()=>{this.struggleScore.setDecayRate(2)},5e3)}registerContextShift(t=!1){this.momentumEndsAt=0,this.uTurnCounter=0,this.sensitivityMultiplier=2,this.sensitivityEndsAt=Date.now()+3e4,console.log(`[BehaviorEngine] Context Shift! Sensitivity doubled. Submit: ${t}`)}handleFocus(t){const e=s(t),i=n(t),r=t.id||null,o=Date.now();if(this.pruneHistory(o),this.interactedElements.has(e))return;this.focusBuffer.push({id:r,xpath:i,timestamp:o}),this.focusBuffer.length>this.maxFocusBuffer&&this.focusBuffer.shift();const a=t.getBoundingClientRect();this.focusClusterBuffer.push({x:a.left,y:a.top,selector:e,timestamp:o}),this.focusClusterBuffer.length>5&&this.focusClusterBuffer.shift(),this.detectClusterLoop(),this.evaluateEfficiency(),this.navigationHistory.push(e),this.navigationHistory.length>this.maxNavHistory&&this.navigationHistory.shift(),this.detectUTurn()}pruneHistory(t){this.focusBuffer=this.focusBuffer.filter(e=>t-e.timestamp<6e4),this.focusClusterBuffer=this.focusClusterBuffer.filter(e=>t-e.timestamp<6e4)}detectClusterLoop(){if(this.focusClusterBuffer.length<5)return;const t=this.focusClusterBuffer.map(t=>t.x),e=this.focusClusterBuffer.map(t=>t.y),i=Math.min(...t),s=Math.max(...t),n=Math.min(...e),r=Math.max(...e);if(s-i<300&&r-n<300){const t=this.focusClusterBuffer.map(t=>t.selector);new Set(t).size<3&&(console.log("[BehaviorEngine] Localized Trap (Cluster) detected"),this.addScore(10,"Localized Trap"))}}evaluateEfficiency(){const t=this.focusBuffer.length;if(t<8)return;const e=new Set(this.focusBuffer.map(t=>t.id||t.xpath)).size/t;e<.25?this.addScore(5,"Low Efficiency"):e>.8&&(this.resetDeadEndTab(),this.struggleScore.get()>0&&this.struggleScore.subtract(20))}detectUTurn(){if(this.navigationHistory.length<5)return;const t=this.navigationHistory,e=t.length,i=t[e-5],s=t[e-4],n=t[e-3],r=t[e-2];i===t[e-1]&&s===r&&i!==s&&s!==n&&(this.uTurnCounter=(this.uTurnCounter||0)+1,this.uTurnCounter>1?(console.log("[BehaviorEngine] Repeated U-Turn detected"),this.addScore(20,"Repeated U-Turn")):(console.log("[BehaviorEngine] Intentional U-Turn (Normalization)"),this.addScore(5,"Minor Backtrack")),this.navigationHistory=[])}handleClick(t){const e=s(t),i=Date.now(),n=function(t){try{return"pointer"===window.getComputedStyle(t).cursor}catch(e){return!1}}(t),r=["a","button","input","select","textarea"].includes(t.tagName.toLowerCase())||t.hasAttribute("onclick")||"button"===t.getAttribute("role");(r||n)&&(this.pendingSuccess={timestamp:i,type:"click",selector:e},setTimeout(()=>{this.pendingSuccess&&this.pendingSuccess.timestamp===i&&(this.pendingSuccess=null)},1e3)),["input","textarea","select"].includes(t.tagName.toLowerCase())&&this.interactedElements.add(e),"submit"!==t.getAttribute("type")&&"button"!==t.getAttribute("role")||this.registerContextShift(!0),this.clickHistory.has(e)||this.clickHistory.set(e,[]);const o=this.clickHistory.get(e);o.push(i);const a=o.filter(t=>i-t<2e3);this.clickHistory.set(e,a),a.length>5&&(n||r?(console.log("[BehaviorEngine] Potential Broken Button / Dead-End Click sequence"),this.addScore(40,"Button Mashing"),this.clickHistory.delete(e)):(this.addScore(60,"Rage Click (Static)"),this.clickHistory.delete(e)))}registerMutation(){this.pendingSuccess&&(console.log(`[BehaviorEngine] Click on ${this.pendingSuccess.selector} verified by DOM mutation. Registering Success.`),this.registerSuccess(),this.pendingSuccess=null)}handleTab(){this.tabCount++,this.tabCount>15&&(this.addScore(40,"Dead-End Tab"),this.tabCount=0)}resetDeadEndTab(){this.tabCount=0}handleInputFocus(t){"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName||(this.currentInputObj={element:t,startValue:t.value,maxLenReached:t.value.length,typed:!1})}handleInputType(t){this.registerSuccess(),this.currentInputObj&&this.currentInputObj.element===t&&(this.currentInputObj.typed=!0,this.interactedElements.add(s(t)),t.value.length>this.currentInputObj.maxLenReached&&(this.currentInputObj.maxLenReached=t.value.length))}handleInputBlur(t){if(this.currentInputObj&&this.currentInputObj.element===t){const e=t.value.length,i=this.currentInputObj.startValue.length,s=this.currentInputObj.maxLenReached-i;this.currentInputObj.typed&&(s>0&&s<3)&&e<=i&&this.addScore(20,"Input Abandonment"),this.currentInputObj=null}}}class o{constructor(t){if(!t||!t.tenantId||!t.collectorEndpoint)throw new Error("TrapAlert requires tenantId and collectorEndpoint");this.tenantId=t.tenantId,this.collectorEndpoint=t.collectorEndpoint,this.struggleScore=new e,this.behavioralTrace=[],this.maxTraceLength=20,this.behaviorEngine=new r(this.struggleScore),this.behaviorEngine.onTrigger=()=>{this.lastTriggerTime=Date.now()},this.focusHistory=[],this.escPressHistory=[],this.lastProductiveTime=Date.now(),this.startTime=Date.now(),this.lastTriggerTime=Date.now(),this.activationThreshold=100,this.triggerLevel=0,this.notificationShown=!1,this.ui=null,this.init()}init(){this.setupUI(),this.attachListeners(),this.startDecayTimer(),this.startVelocityGateMonitor(),console.log(`[TrapAlert] Initialized for tenant: ${this.tenantId}`)}startVelocityGateMonitor(){setInterval(()=>{const t=Date.now(),e=t-this.startTime,i=t-this.lastTriggerTime;e>6e5&&i>6e5&&100===this.activationThreshold&&(this.activationThreshold=120,console.log("[TrapAlert] Velocity Gate: Increasing threshold to 120 for happy user."))},6e4)}setupUI(){const t=document.createElement("div");t.id="trapalert-container",t.setAttribute("aria-hidden","false"),document.body.appendChild(t);const e=t.attachShadow({mode:"open"});this.ui=new i(e,()=>this.handleReport(),()=>this.handleDismiss())}attachListeners(){window.addEventListener("focusin",this.handleFocusIn.bind(this),!0),window.addEventListener("focusout",this.handleFocusOut.bind(this),!0),window.addEventListener("keydown",this.handleKeyDown.bind(this),!0),window.addEventListener("click",this.handleClick.bind(this),!0),window.addEventListener("input",this.handleInput.bind(this),!0),window.addEventListener("keydown",this.handleShortcut.bind(this),!0),this.observer=new MutationObserver(this.handleMutations.bind(this)),this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["role","aria-live","class","style"]}),window.addEventListener("visibilitychange",()=>{document.hidden&&(console.log("[TrapAlert] Tab hidden - resetting frustration engine"),this.struggleScore.reset(),this.triggerLevel=0,this.behaviorEngine.resetDeadEndTab())})}handleMutations(t){t.length>0&&this.behaviorEngine.registerMutation();for(const e of t)"childList"===e.type?e.addedNodes.forEach(t=>{1===t.nodeType&&this.checkErrorNode(t)}):"attributes"===e.type&&this.checkErrorNode(e.target)}checkErrorNode(t){if(!t.getAttribute)return;const e=t.getAttribute("role"),i=t.getAttribute("aria-live");("alert"===e||"assertive"===i||t.className&&"string"==typeof t.className&&t.className.toLowerCase().includes("error"))&&(console.log("[TrapAlert] Error message detected (DOM Mutation)"),this.behaviorEngine.registerContextShift(!1))}handleFocusIn(t){const e=t.target,i=s(e),n=Date.now();this.addToTrace("focusin",i),this.focusHistory.push({element:e,selector:i,timestamp:n}),this.focusHistory=this.focusHistory.filter(t=>n-t.timestamp<6e4),this.focusHistory.length>20&&this.focusHistory.shift(),this.behaviorEngine.handleFocus(e),this.behaviorEngine.handleInputFocus(e),this.checkThreshold()}handleFocusOut(t){this.behaviorEngine.handleInputBlur(t.target),this.checkThreshold()}handleKeyDown(t){this.addToTrace("keydown",t.key),"Tab"===t.key&&(this.behaviorEngine.handleTab(),this.checkThreshold()),"Escape"===t.key&&this.handleEscapePress()}handleEscapePress(){const t=Date.now();this.escPressHistory.push(t),this.escPressHistory=this.escPressHistory.filter(e=>t-e<3e3),this.escPressHistory.length>=3&&(console.log("[TrapAlert] Rapid Escape presses detected"),this.struggleScore.add(50),this.checkThreshold(),this.escPressHistory=[])}handleClick(t){const e=t.target,i=s(e);this.addToTrace("click",i),this.markProductiveBehavior(),this.behaviorEngine.handleClick(e),this.checkThreshold()}handleInput(t){this.addToTrace("input",s(t.target)),this.markProductiveBehavior(),this.behaviorEngine.handleInputType(t.target)}markProductiveBehavior(){this.lastProductiveTime=Date.now(),this.behaviorEngine.resetDeadEndTab()}handleShortcut(t){t.altKey&&"t"===t.key&&(t.preventDefault(),this.ui.show(this.struggleScore.get()))}startDecayTimer(){setInterval(()=>{this.struggleScore.decay(),this.notificationShown&&this.ui.updateScore(this.struggleScore.get())},1e3)}addToTrace(t,e){this.behavioralTrace.push({type:t,detail:e,timestamp:Date.now(),url:window.location.href}),this.behavioralTrace.length>this.maxTraceLength&&this.behavioralTrace.shift()}checkThreshold(){const t=this.struggleScore.get(),e=this.activationThreshold,i=2*e;0===this.triggerLevel&&t>=e?(console.log(`[TrapAlert] Level 1 Trigger (Score: ${t}, Threshold: ${e})`),this.triggerLevel=1,this.notifyUser()):1===this.triggerLevel&&t>=i&&(console.log(`[TrapAlert] Level 2 Escalation (Score: ${t}, Threshold: ${i})`),this.triggerLevel=2,this.notifyUser()),t<10&&0!==this.triggerLevel&&(this.triggerLevel=0)}notifyUser(){this.notificationShown||(this.notificationShown=!0,this.ui.show(this.struggleScore.get()))}handleDismiss(){this.notificationShown=!1}handleReport(){this.dispatchReport(),this.notificationShown=!1,this.struggleScore.reset(),this.triggerLevel=0}dispatchReport(){const t={tenantId:this.tenantId,timestamp:(new Date).toISOString(),url:window.location.href,struggleScore:this.struggleScore.get(),behavioralTrace:this.behavioralTrace,context:this.captureContext(),metadata:this.getBrowserMetadata()};if(console.log("[TrapAlert] Dispatching report:",t),navigator.sendBeacon){const e=new Blob([JSON.stringify(t)],{type:"application/json"});navigator.sendBeacon(this.collectorEndpoint,e)||this.fallbackFetch(t)}else this.fallbackFetch(t)}fallbackFetch(t){fetch(this.collectorEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),keepalive:!0}).catch(t=>{console.error("[TrapAlert] Failed to send report:",t)})}captureContext(){const t=document.activeElement;return{activeElement:{selector:s(t),outerHTML:t?t.outerHTML:null,tagName:t?t.tagName:null,role:t?t.getAttribute("role"):null},focusHistory:this.focusHistory.map(t=>({selector:t.selector,timestamp:t.timestamp})),pageTitle:document.title,scrollPosition:{x:window.scrollX,y:window.scrollY}}}getBrowserMetadata(){return{userAgent:navigator.userAgent,screenSize:{width:window.screen.width,height:window.screen.height},viewportSize:{width:window.innerWidth,height:window.innerHeight},language:navigator.language,platform:navigator.platform,timestamp:Date.now()}}}"undefined"!=typeof window&&(window.TrapAlert={init:t=>new o(t)}),t.TrapAlert=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=trapalert.umd.js.map
