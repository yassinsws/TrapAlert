{"version":3,"file":"trapalert.es.js","sources":["../src/core/StruggleScore.js","../src/ui/NotificationSystem.js","../src/utils/dom.js","../src/core/BehaviorEngine.js","../src/utils/dom-snapshot.js","../src/core/TrapAlert.js","../src/index.js"],"sourcesContent":["/**\n * StruggleScore - Manages the frustration meter (0-100)\n */\nexport class StruggleScore {\n    constructor(decayRate = 2) {\n        this.score = 0;\n        this.lastDecayTime = Date.now();\n        this.decayRate = decayRate; // points per second\n    }\n\n    setDecayRate(rate) {\n        this.decayRate = rate;\n    }\n\n    add(points) {\n        this.score = this.score + points;\n        return this.score;\n    }\n\n    subtract(points) {\n        this.score = Math.max(0, this.score - points);\n        return this.score;\n    }\n\n    decay() {\n        const now = Date.now();\n        const elapsed = (now - this.lastDecayTime) / 1000; // seconds\n\n        if (elapsed >= 1) {\n            const decayAmount = elapsed * this.decayRate;\n            this.subtract(decayAmount);\n            this.lastDecayTime = now;\n        }\n    }\n\n    get() {\n        return this.score;\n    }\n\n    reset() {\n        this.score = 0;\n        this.lastDecayTime = Date.now();\n    }\n}\n","export class NotificationSystem {\n  constructor(shadowRoot, onReport, onDismiss) {\n    this.shadowRoot = shadowRoot;\n    this.onReport = onReport;\n    this.onDismiss = onDismiss;\n    this.ariaLiveRegion = null;\n    this.initialize();\n  }\n\n  initialize() {\n    this.createAriaLiveRegion();\n    this.createSidebar();\n  }\n\n  createAriaLiveRegion() {\n    this.ariaLiveRegion = document.createElement('div');\n    this.ariaLiveRegion.setAttribute('role', 'status');\n    this.ariaLiveRegion.setAttribute('aria-live', 'assertive');\n    this.ariaLiveRegion.setAttribute('aria-atomic', 'true');\n    this.ariaLiveRegion.style.cssText = `\n      position: absolute;\n      left: -10000px;\n      width: 1px;\n      height: 1px;\n      overflow: hidden;\n    `;\n    this.shadowRoot.appendChild(this.ariaLiveRegion);\n  }\n\n  createSidebar() {\n    const style = document.createElement('style');\n    style.textContent = `\n      :host {\n        --ta-blue: #667eea;\n        --ta-purple: #764ba2;\n        --ta-sidebar-width: 350px;\n      }\n\n      .trapalert-sidebar {\n        position: fixed;\n        top: 0;\n        right: calc(var(--ta-sidebar-width) * -1);\n        width: var(--ta-sidebar-width);\n        height: 100vh;\n        background: linear-gradient(135deg, #1a1c2c 0%, #4a192c 100%);\n        box-shadow: -4px 0 30px rgba(0, 0, 0, 0.5);\n        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        z-index: 999999;\n        color: white;\n        font-family: 'Outfit', sans-serif;\n        display: flex;\n        flex-direction: column;\n        padding: 40px 30px;\n        box-sizing: border-box;\n        border-left: 1px solid rgba(255, 255, 255, 0.1);\n      }\n\n      .trapalert-sidebar.visible {\n        right: 0;\n      }\n\n      .trapalert-handle {\n        position: fixed;\n        right: 0;\n        top: 50%;\n        transform: translateY(-50%);\n        background: #1a1c2c;\n        color: white;\n        padding: 15px 8px;\n        border-radius: 8px 0 0 8px;\n        cursor: pointer;\n        writing-mode: vertical-rl;\n        text-orientation: mixed;\n        font-size: 12px;\n        font-weight: 600;\n        letter-spacing: 1px;\n        text-transform: uppercase;\n        border: 1px solid rgba(255,255,255,0.2);\n        border-right: none;\n        transition: padding 0.2s;\n        z-index: 999998;\n        box-shadow: -2px 0 10px rgba(0,0,0,0.3);\n      }\n\n      .trapalert-handle:hover {\n        padding-right: 15px;\n        background: #2a2c3c;\n      }\n\n      .trapalert-header {\n        font-size: 24px;\n        font-weight: 700;\n        margin-bottom: 20px;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n      }\n\n      .trapalert-icon {\n        width: 36px;\n        height: 36px;\n        background: rgba(255, 255, 255, 0.1);\n        border-radius: 10px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 22px;\n      }\n\n      .trapalert-message {\n        font-size: 15px;\n        line-height: 1.6;\n        margin-bottom: 30px;\n        color: rgba(255, 255, 255, 0.8);\n      }\n\n      .trapalert-score {\n        background: rgba(0, 0, 0, 0.3);\n        padding: 20px;\n        border-radius: 12px;\n        margin-bottom: 25px;\n        border: 1px solid rgba(255, 255, 255, 0.05);\n      }\n\n      .trapalert-score-label {\n        font-size: 11px;\n        text-transform: uppercase;\n        letter-spacing: 1.5px;\n        opacity: 0.6;\n        margin-bottom: 8px;\n      }\n\n      .trapalert-score-value {\n        font-size: 42px;\n        font-weight: 800;\n        background: linear-gradient(to right, #fff, #aab);\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n      }\n\n      .trapalert-button {\n        background: white;\n        color: #1a1c2c;\n        border: none;\n        padding: 16px 24px;\n        border-radius: 10px;\n        font-size: 15px;\n        font-weight: 700;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        margin-bottom: 12px;\n      }\n\n      .trapalert-button:hover {\n        background: #f0f0f0;\n        transform: translateY(-2px);\n      }\n\n      .trapalert-button-secondary {\n        background: rgba(255, 255, 255, 0.1);\n        color: white;\n        border: 1px solid rgba(255, 255, 255, 0.1);\n      }\n\n      .trapalert-button-secondary:hover {\n        background: rgba(255, 255, 255, 0.15);\n      }\n\n      .trapalert-close {\n        position: absolute;\n        top: 20px;\n        right: 20px;\n        background: rgba(255, 255, 255, 0.05);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        color: white;\n        width: 32px;\n        height: 32px;\n        border-radius: 50%;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s;\n      }\n\n      .trapalert-close:hover {\n        background: rgba(255, 255, 255, 0.2);\n        transform: rotate(90deg);\n      }\n\n      .trapalert-timer {\n        font-family: monospace;\n        font-size: 28px;\n        color: #ff4d4d;\n        font-weight: 800;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        margin: 20px 0;\n      }\n\n      .trapalert-timer::before {\n        content: '';\n        width: 14px;\n        height: 14px;\n        background: #ff4d4d;\n        border-radius: 50%;\n        animation: ta-pulse 1s infinite;\n      }\n\n      @keyframes ta-pulse {\n        0% { opacity: 1; transform: scale(1); }\n        50% { opacity: 0.4; transform: scale(1.2); }\n        100% { opacity: 1; transform: scale(1); }\n      }\n\n\n\n      .trapalert-input {\n        width: 100%;\n        background: rgba(0, 0, 0, 0.3);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        border-radius: 8px;\n        padding: 12px;\n        margin-bottom: 15px;\n        color: white;\n        font-family: inherit;\n        font-size: 14px;\n        resize: vertical;\n        box-sizing: border-box;\n      }\n\n      .trapalert-input:focus {\n        outline: none;\n        border-color: var(--ta-blue);\n        background: rgba(0, 0, 0, 0.5);\n      }\n    `;\n    this.shadowRoot.appendChild(style);\n\n    const handle = document.createElement('button');\n    handle.className = 'trapalert-handle';\n    handle.id = 'ta-handle';\n    handle.setAttribute('aria-label', 'Open TrapAlert Reporting Tool');\n    handle.textContent = 'Report Barrier';\n    this.shadowRoot.appendChild(handle);\n\n    const sidebar = document.createElement('aside');\n    sidebar.className = 'trapalert-sidebar';\n    sidebar.setAttribute('role', 'complementary');\n    sidebar.setAttribute('aria-label', 'TrapAlert Accessibility Tool');\n\n    sidebar.innerHTML = `\n      <button class=\"trapalert-close\" id=\"ta-close\" aria-label=\"Close TrapAlert\">√ó</button>\n      <div class=\"trapalert-header\">\n        <div class=\"trapalert-icon\">üõ°Ô∏è</div>\n        <span>TrapAlert</span>\n      </div>\n\n      <!-- Idle UI -->\n      <div id=\"idle-ui\" style=\"display: flex; flex-direction: column;\">\n        <div class=\"trapalert-message\">\n          We've detected potential navigation barriers. Help us improve the experience for everyone.\n        </div>\n\n\n        <textarea id=\"issue-description\" class=\"trapalert-input\" rows=\"3\" placeholder=\"Describe the issue (optional)...\"></textarea>\n\n        <button class=\"trapalert-button\" id=\"start-recording-btn\">\n          üé• Record Feedback (Voice + Screen)\n        </button>\n        <button class=\"trapalert-button trapalert-button-secondary\" id=\"dismiss-btn\">\n          Keep Browsing\n        </button>\n      </div>\n\n      <!-- Recording UI -->\n      <div id=\"recording-ui\" style=\"display: none; flex-direction: column; align-items: center;\">\n        <div class=\"trapalert-timer\" id=\"recording-timer\">00:00</div>\n        <div class=\"trapalert-message\" style=\"text-align: center; margin-top: 10px;\">\n           Recording in progress...\n        </div>\n        <button class=\"trapalert-button\" id=\"stop-recording-btn\" style=\"background: #ff4d4d; color: white; width: 100%; margin-top: 20px;\">\n          ‚èπÔ∏è Stop and Send\n        </button>\n      </div>\n\n      <!-- Uploading UI -->\n      <div id=\"uploading-ui\" style=\"display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%;\">\n        <div class=\"trapalert-icon\" style=\"width: 60px; height: 60px; font-size: 40px; margin-bottom: 20px;\">‚è≥</div>\n        <div class=\"trapalert-header\" style=\"justify-content: center;\">\n            <span>Finalizing...</span>\n        </div>\n        <div class=\"trapalert-message\" style=\"text-align: center;\">\n           Securely packaging your screen recording and DOM snapshot.\n        </div>\n      </div>\n    `;\n    this.shadowRoot.appendChild(sidebar);\n\n    this.bindEvents();\n  }\n\n  bindEvents() {\n    const handle = this.shadowRoot.querySelector('#ta-handle');\n    const closeBtn = this.shadowRoot.querySelector('#ta-close');\n    const dismissBtn = this.shadowRoot.querySelector('#dismiss-btn');\n    const startRecordBtn = this.shadowRoot.querySelector('#start-recording-btn');\n    const stopRecordBtn = this.shadowRoot.querySelector('#stop-recording-btn');\n\n    handle.addEventListener('click', () => this.show());\n    closeBtn.addEventListener('click', () => this.hide());\n    dismissBtn.addEventListener('click', () => {\n      this.hide();\n      this.onDismiss();\n    });\n\n    startRecordBtn.addEventListener('click', () => {\n      if (this.onStartRecording) this.onStartRecording();\n    });\n\n    stopRecordBtn.addEventListener('click', () => {\n      if (this.onStopRecording) this.onStopRecording();\n    });\n  }\n\n  setRecordingState(state) {\n    const idleUI = this.shadowRoot.querySelector('#idle-ui');\n    const recordingUI = this.shadowRoot.querySelector('#recording-ui');\n    const uploadingUI = this.shadowRoot.querySelector('#uploading-ui');\n\n    if (idleUI) idleUI.style.display = state === 'idle' ? 'flex' : 'none';\n    if (recordingUI) recordingUI.style.display = state === 'recording' ? 'flex' : 'none';\n    if (uploadingUI) uploadingUI.style.display = state === 'uploading' ? 'flex' : 'none';\n\n    if (state === 'recording') {\n      this.startTimer();\n    } else {\n      this.stopTimer();\n    }\n  }\n\n  startTimer() {\n    let seconds = 0;\n    const timerEl = this.shadowRoot.querySelector('#recording-timer');\n    if (this.timerInterval) clearInterval(this.timerInterval);\n\n    this.timerInterval = setInterval(() => {\n      seconds++;\n      const mins = Math.floor(seconds / 60).toString().padStart(2, '0');\n      const secs = (seconds % 60).toString().padStart(2, '0');\n      if (timerEl) timerEl.textContent = `${mins}:${secs}`;\n    }, 1000);\n  }\n\n  stopTimer() {\n    if (this.timerInterval) {\n      clearInterval(this.timerInterval);\n      this.timerInterval = null;\n    }\n  }\n\n  show(score) {\n    const sidebar = this.shadowRoot.querySelector('.trapalert-sidebar');\n    const handle = this.shadowRoot.querySelector('#ta-handle');\n\n    if (sidebar) {\n      this.setRecordingState('idle'); // Always start with idle\n      sidebar.classList.add('visible');\n      if (handle) handle.style.display = 'none';\n\n      document.body.classList.add('trapalert-open');\n\n      // Programmatic focus for accessibility\n      setTimeout(() => {\n        const closeBtn = this.shadowRoot.querySelector('#ta-close');\n        if (closeBtn) closeBtn.focus();\n      }, 300);\n\n      this.announce('TrapAlert: Accessibility barrier detected. Sidebar opened.');\n    }\n  }\n\n  hide() {\n    const sidebar = this.shadowRoot.querySelector('.trapalert-sidebar');\n    const handle = this.shadowRoot.querySelector('#ta-handle');\n\n    if (sidebar) {\n      this.stopTimer();\n      sidebar.classList.remove('visible');\n      if (handle) handle.style.display = 'block';\n      document.body.classList.remove('trapalert-open');\n    }\n  }\n\n  announce(message) {\n    if (this.ariaLiveRegion) {\n      this.ariaLiveRegion.textContent = message;\n    }\n  }\n\n  updateMessage(message) {\n    this.announce(message);\n    const messageEl = this.shadowRoot.querySelector('.trapalert-message');\n    if (messageEl) {\n      messageEl.textContent = message;\n    }\n  }\n\n  getDescription() {\n    const input = this.shadowRoot.querySelector('#issue-description');\n    return input ? input.value : '';\n  }\n}","/**\n * Get CSS selector for element\n * @param {HTMLElement} element \n * @returns {string} Unique-ish selector\n */\nexport function getElementSelector(element) {\n    if (!element || element === document) return 'document';\n    if (element === window) return 'window';\n\n    if (element.id) {\n        return `#${element.id}`;\n    }\n\n    if (element.className && typeof element.className === 'string') {\n        const classes = element.className.trim().split(/\\s+/).join('.');\n        if (classes) {\n            return `${element.tagName.toLowerCase()}.${classes}`;\n        }\n    }\n\n    return element.tagName.toLowerCase();\n}\n\n/**\n * Check if element is interactive\n * @param {HTMLElement} element \n * @returns {boolean}\n */\nexport function isInteractiveElement(element) {\n    const tagName = element.tagName.toLowerCase();\n    const interactiveTags = ['a', 'button', 'input', 'select', 'textarea'];\n\n    if (interactiveTags.includes(tagName)) return true;\n    if (element.hasAttribute('onclick')) return true;\n    if (element.getAttribute('role') === 'button') return true;\n    if (element.hasAttribute('href')) return true;\n    if (element.hasAttribute('tabindex') && element.getAttribute('tabindex') !== '-1') return true;\n\n    return false;\n}\n\n/**\n * Check if element has pointer cursor\n * @param {HTMLElement} element \n * @returns {boolean}\n */\nexport function hasPointerCursor(element) {\n    try {\n        const style = window.getComputedStyle(element);\n        return style.cursor === 'pointer';\n    } catch (e) {\n        return false;\n    }\n}\n\n/**\n * Get simple XPath for element\n * @param {HTMLElement} element \n * @returns {string}\n */\nexport function getElementXPath(element) {\n    if (element.id !== '') return `//*[@id=\"${element.id}\"]`;\n    if (element === document.body) return '/html/body';\n\n    let ix = 0;\n    const siblings = element.parentNode ? element.parentNode.childNodes : [];\n\n    for (let i = 0; i < siblings.length; i++) {\n        const sibling = siblings[i];\n        if (sibling === element) {\n            return getElementXPath(element.parentNode) + '/' + element.tagName.toLowerCase() + '[' + (ix + 1) + ']';\n        }\n        if (sibling.nodeType === 1 && sibling.tagName === element.tagName) {\n            ix++;\n        }\n    }\n    return '';\n}\n","import { getElementSelector, hasPointerCursor, getElementXPath } from '../utils/dom.js';\n\n/**\n * BehaviorEngine - Advanced logic for detecting struggle vs power usage\n */\nexport class BehaviorEngine {\n    constructor(struggleScore) {\n        this.struggleScore = struggleScore;\n\n        // Efficiency Ratio State\n        this.focusBuffer = []; // stores { id, xpath }\n        this.maxFocusBuffer = 20;\n\n        // U-Turn State\n        this.navigationHistory = []; // stores selector strings\n        this.maxNavHistory = 10;\n\n        // Rage Click State\n        this.clickHistory = new Map(); // selector -> [timestamps]\n\n        // Dead-End Tab State\n        this.tabCount = 0;\n        this.lastProductiveAction = Date.now();\n\n        // Input Abandonment State\n        this.currentInputObj = null; // { element, startLen, maxLen, typed }\n\n        // Advanced Heuristics State\n        this.momentumEndsAt = 0; // Timestamp when success momentum buffer ends\n        this.sensitivityMultiplier = 1; // Default sensitivity\n        this.sensitivityEndsAt = 0; // Timestamp when high sensitivity ends\n        this.interactedElements = new Set(); // Selectors of elements user has productively interacted with\n        this.focusClusterBuffer = []; // stores { x, y } for cluster analysis\n    }\n\n    /**\n     * Helper to add score with momentum and sensitivity applied\n     */\n    addScore(points, reason) {\n        const now = Date.now();\n        let finalPoints = points;\n\n        // Mark trigger for velocity gate\n        if (this.onTrigger) this.onTrigger();\n\n        // Apply Sensitivity Multiplier\n        if (now < this.sensitivityEndsAt) {\n            finalPoints *= this.sensitivityMultiplier;\n        }\n\n        // Apply Success Momentum (Buffer)\n        // Bypass buffer for Rage Clicks or serious context sensitivity\n        const isFrustrationMarker = points >= 60 || reason === 'Rage Click';\n\n        if (now < this.momentumEndsAt && !isFrustrationMarker) {\n            // Buffer reduces increments by 80%\n            finalPoints *= 0.2;\n        }\n\n        finalPoints = Math.round(finalPoints);\n\n        if (finalPoints > 0) {\n            console.log(`[BehaviorEngine] Adding ${finalPoints} points (${reason}). Base: ${points}, Sens: ${this.sensitivityMultiplier}, Mom: ${now < this.momentumEndsAt}`);\n            this.struggleScore.add(finalPoints);\n        }\n    }\n\n    /**\n     * Register a successful action (typing, clicking, navigating)\n     */\n    registerSuccess() {\n        this.momentumEndsAt = Date.now() + 5000; // 5 second buffer\n        this.resetDeadEndTab();\n        this.uTurnCounter = 0; // Reset grace period on success\n\n        // High decay rate during momentum\n        this.struggleScore.setDecayRate(10);\n\n        // Instant drain\n        this.struggleScore.subtract(10);\n\n        // Revert decay rate after 5 seconds\n        if (this.decayRevertTimeout) clearTimeout(this.decayRevertTimeout);\n        this.decayRevertTimeout = setTimeout(() => {\n            this.struggleScore.setDecayRate(2);\n        }, 5000);\n    }\n\n    /**\n     * Register a high-risk context shift (error message, submit click)\n     */\n    registerContextShift(isSubmit = false) {\n        // Clear momentum immediately\n        this.momentumEndsAt = 0;\n        this.uTurnCounter = 0; // Reset for fresh state\n\n        // Increase sensitivity\n        this.sensitivityMultiplier = 2;\n        this.sensitivityEndsAt = Date.now() + 30000; // 30 seconds\n\n        console.log(`[BehaviorEngine] Context Shift! Sensitivity doubled. Submit: ${isSubmit}`);\n    }\n\n    /**\n     * Process focusin events for Efficiency Ratio & U-Turn\n     */\n    handleFocus(element) {\n        const selector = getElementSelector(element);\n        const xpath = getElementXPath(element);\n        const id = element.id || null;\n        const now = Date.now();\n\n        // 0. History Pruning: Remove events older than 60 seconds\n        this.pruneHistory(now);\n\n        // Check if previously interacted (Interaction History)\n        if (this.interactedElements.has(selector)) {\n            // Do not penalize re-focusing inputs they already worked on\n            return;\n        }\n\n        // 1. Efficiency Ratio Buffer update\n        this.focusBuffer.push({ id, xpath, timestamp: now });\n        if (this.focusBuffer.length > this.maxFocusBuffer) {\n            this.focusBuffer.shift();\n        }\n\n        // 2. Cluster-Loop Detection\n        const rect = element.getBoundingClientRect();\n        this.focusClusterBuffer.push({\n            x: rect.left,\n            y: rect.top,\n            selector: selector,\n            timestamp: now\n        });\n        if (this.focusClusterBuffer.length > 5) this.focusClusterBuffer.shift();\n\n        this.detectClusterLoop();\n\n        this.evaluateEfficiency();\n\n        // 3. U-Turn Detection\n        this.navigationHistory.push(selector);\n        if (this.navigationHistory.length > this.maxNavHistory) {\n            this.navigationHistory.shift();\n        }\n        this.detectUTurn();\n    }\n\n    pruneHistory(now) {\n        const threshold = 60000; // 60 seconds\n        this.focusBuffer = this.focusBuffer.filter(item => now - item.timestamp < threshold);\n        this.focusClusterBuffer = this.focusClusterBuffer.filter(item => now - item.timestamp < threshold);\n    }\n\n    detectClusterLoop() {\n        if (this.focusClusterBuffer.length < 5) return;\n\n        // Visual Distance Check: Are all 5 points within a 300px box?\n        const xs = this.focusClusterBuffer.map(p => p.x);\n        const ys = this.focusClusterBuffer.map(p => p.y);\n\n        const minX = Math.min(...xs);\n        const maxX = Math.max(...xs);\n        const minY = Math.min(...ys);\n        const maxY = Math.max(...ys);\n\n        const width = maxX - minX;\n        const height = maxY - minY;\n\n        if (width < 300 && height < 300) {\n            // Check for repetition within the cluster (avoid flagging toolbars)\n            const selectors = this.focusClusterBuffer.map(p => p.selector);\n            const uniqueInCluster = new Set(selectors).size;\n\n            // If we have 5 events but only 1 or 2 unique elements, we are vibrating in place\n            // (U-Turn logic handles 3-element patterns like A-B-C-B-A better)\n            if (uniqueInCluster < 3) {\n                console.log('[BehaviorEngine] Localized Trap (Cluster) detected');\n                this.addScore(10, 'Localized Trap');\n            }\n        }\n    }\n\n    /**\n     * \"Efficiency Ratio\" Logic\n     */\n    evaluateEfficiency() {\n        const totalEvents = this.focusBuffer.length;\n        if (totalEvents < 8) return; // Wait for a more robust sample (was 5)\n\n        // Definition of Unique Focus: The count of unique id or xpath attributes\n        const uniqueKeys = new Set(this.focusBuffer.map(item => item.id || item.xpath));\n        const uniqueCount = uniqueKeys.size;\n\n        const efficiency = uniqueCount / totalEvents;\n\n        // Behavioral Trigger\n        if (efficiency < 0.25) { // Slightly more strict (was 0.3)\n            // User is hitting the same 4-5 elements repeatedly\n            this.addScore(5, 'Low Efficiency');\n        } else if (efficiency > 0.8) {\n            // Power User Protection\n            // Decrease Struggle Score by -20 points\n            // Note: Limit frequency of this reward or check if we just crossed the threshold?\n            // \"Decrease Struggle Score by -20 points (Power User Protection)\" implies a one-time bonus or periodic?\n            // \"per event\" isn't specified for the bonus, but typically power user behavior is continuous.\n            // If we subtract 20 on EVERY focus event, score will stay 0. That's probably intended.\n            // If exploring effectively, we shouldn't count \"Dead-End Tabs\"\n            this.resetDeadEndTab();\n\n            if (this.struggleScore.get() > 0) {\n                this.struggleScore.subtract(20);\n            }\n        }\n    }\n\n    /**\n     * \"The U-Turn\" Logic\n     * A -> B -> C -> B -> A\n     */\n    detectUTurn() {\n        if (this.navigationHistory.length < 5) return;\n\n        const h = this.navigationHistory;\n        const len = h.length;\n\n        // A -> B -> C -> B -> A\n        // A=idx-4, B=idx-3, C=idx-2, B=idx-1, A=idx\n        const A1 = h[len - 5];\n        const B1 = h[len - 4];\n        const C = h[len - 3];\n        const B2 = h[len - 2];\n        const A2 = h[len - 1];\n\n        if (A1 === A2 && B1 === B2 && A1 !== B1 && B1 !== C) {\n            // First U-Turn is often a valid correction.\n            // Only penalize if they've done it recently or are in a sensitive state.\n            this.uTurnCounter = (this.uTurnCounter || 0) + 1;\n\n            if (this.uTurnCounter > 1) {\n                console.log('[BehaviorEngine] Repeated U-Turn detected');\n                this.addScore(20, 'Repeated U-Turn'); // Reduced from 30\n            } else {\n                console.log('[BehaviorEngine] Intentional U-Turn (Normalization)');\n                // If it's a one-off, we grant a \"grace\" score\n                this.addScore(5, 'Minor Backtrack');\n            }\n\n            // Clear history and reset counter if they start moving again\n            this.navigationHistory = [];\n        }\n    }\n\n    /**\n     * \"Rage Clicking\" Logic\n     */\n    handleClick(element) {\n        const selector = getElementSelector(element);\n        const now = Date.now();\n\n        const hasPointer = hasPointerCursor(element);\n        const likelyInteractive = ['a', 'button', 'input', 'select', 'textarea'].includes(element.tagName.toLowerCase())\n            || element.hasAttribute('onclick')\n            || element.getAttribute('role') === 'button';\n\n        // 1. Success Verification: Don't give momentum until we see a result (mutation)\n        if (likelyInteractive || hasPointer) {\n            this.pendingSuccess = {\n                timestamp: now,\n                type: 'click',\n                selector: selector\n            };\n            // We'll wait for a mutation to confirm\n            setTimeout(() => {\n                if (this.pendingSuccess && this.pendingSuccess.timestamp === now) {\n                    this.pendingSuccess = null; // Expired\n                }\n            }, 1000);\n        }\n\n        // Track interaction for history\n        if (['input', 'textarea', 'select'].includes(element.tagName.toLowerCase())) {\n            this.interactedElements.add(selector);\n        }\n\n        // Check for Submit button click\n        if (element.getAttribute('type') === 'submit' || element.getAttribute('role') === 'button') {\n            this.registerContextShift(true);\n        }\n\n        if (!this.clickHistory.has(selector)) {\n            this.clickHistory.set(selector, []);\n        }\n\n        const clicks = this.clickHistory.get(selector);\n        clicks.push(now);\n\n        const recentClicks = clicks.filter(t => now - t < 2000);\n        this.clickHistory.set(selector, recentClicks);\n\n        if (recentClicks.length > 5) {\n            if (!hasPointer && !likelyInteractive) {\n                // Rage clicking on static text\n                this.addScore(60, 'Rage Click (Static)');\n                this.clickHistory.delete(selector);\n            } else {\n                // Rage clicking on a BUTTON (Possible Dead-End/Broken Button)\n                // This answers: \"what if the button is not working?\"\n                console.log('[BehaviorEngine] Potential Broken Button / Dead-End Click sequence');\n                this.addScore(40, 'Button Mashing'); // Serious frustration but potentially valid (just slow)\n                this.clickHistory.delete(selector);\n            }\n        }\n    }\n\n    /**\n     * Called by TrapAlert when a DOM mutation is detected\n     */\n    registerMutation() {\n        if (this.pendingSuccess) {\n            console.log(`[BehaviorEngine] Click on ${this.pendingSuccess.selector} verified by DOM mutation. Registering Success.`);\n            this.registerSuccess();\n            this.pendingSuccess = null;\n        }\n    }\n\n    /**\n     * \"The Dead-End Tab\"\n     * >15 tabs without a single change (or while stuck).\n     * If handled in handleFocus via efficiency resets, this just catches\n     * pure rapid tabbing without focus change (rare) OR low-efficiency tabbing.\n     */\n    handleTab() {\n        // We defer penalty. If the user tabs 15 times but Efficiency is High, evaluateEfficiency resets this.\n        // If Efficiency is Low (Looping), this accumulates and penalizes ON TOP of Efficiency penalties.\n        this.tabCount++;\n        if (this.tabCount > 15) {\n            this.addScore(40, 'Dead-End Tab');\n            this.tabCount = 0;\n        }\n    }\n\n    resetDeadEndTab() {\n        this.tabCount = 0;\n    }\n\n    /**\n     * \"Input Abandonment\"\n     * User clicks an input, types <3 chars, deletes them, and tabs away.\n     */\n    handleInputFocus(element) {\n        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {\n            this.currentInputObj = {\n                element: element,\n                startValue: element.value,\n                maxLenReached: element.value.length,\n                typed: false\n            };\n        }\n    }\n\n    handleInputType(element) {\n        this.registerSuccess();\n\n        if (this.currentInputObj && this.currentInputObj.element === element) {\n            this.currentInputObj.typed = true;\n            this.interactedElements.add(getElementSelector(element)); // Mark as Productive Interaction\n\n            if (element.value.length > this.currentInputObj.maxLenReached) {\n                this.currentInputObj.maxLenReached = element.value.length;\n            }\n        }\n    }\n\n    handleInputBlur(element) {\n        if (this.currentInputObj && this.currentInputObj.element === element) {\n            const finalLen = element.value.length;\n            const startLen = this.currentInputObj.startValue.length;\n            const charsAdded = this.currentInputObj.maxLenReached - startLen; // rough approximation of \"typed\"\n\n            // \"types <3 chars, deletes them (so back to start or empty), and tabs away (blur)\"\n            // Simplification: Check if they typed something small and then cleared/reverted it.\n            const wasEdited = this.currentInputObj.typed;\n            const reverted = finalLen <= startLen; // Or strictly empty? \"deletes them\" triggers usually mean empty or original state\n            const smallEffort = charsAdded > 0 && charsAdded < 3;\n\n            if (wasEdited && smallEffort && reverted) {\n                this.addScore(20, 'Input Abandonment');\n            }\n\n            this.currentInputObj = null;\n        }\n    }\n}\n","/**\n * Serializes the current DOM state into a snapshot.\n * Captures document structure, styles, and form values.\n */\nexport function captureDOMSnapshot() {\n    const doc = document.cloneNode(true);\n    const root = doc.documentElement;\n\n    // 1. Convert relative URLs to absolute URLs\n    const base = window.location.href;\n\n    const convertToAbs = (attr) => {\n        root.querySelectorAll(`[${attr}]`).forEach(el => {\n            const val = el.getAttribute(attr);\n            if (val && !val.startsWith('http') && !val.startsWith('data:') && !val.startsWith('//')) {\n                try {\n                    el.setAttribute(attr, new URL(val, base).href);\n                } catch (e) { }\n            }\n        });\n    };\n\n    ['src', 'href'].forEach(convertToAbs);\n\n    // 2. Capture dynamic state that isn't in outerHTML (scroll, inputs)\n    // We iterate the REAL document and apply values to the CLONE\n    const allRealElements = document.querySelectorAll('*');\n    const allCloneElements = root.querySelectorAll('*');\n\n    allRealElements.forEach((realEl, i) => {\n        const cloneEl = allCloneElements[i];\n        if (!cloneEl) return;\n\n        // Capture input values\n        if (realEl.tagName === 'INPUT' || realEl.tagName === 'TEXTAREA' || realEl.tagName === 'SELECT') {\n            cloneEl.value = realEl.value;\n        }\n\n        // Capture canvas as data URL\n        if (realEl.tagName === 'CANVAS') {\n            const img = doc.createElement('img');\n            img.src = realEl.toDataURL();\n            img.style.cssText = realEl.style.cssText;\n            cloneEl.replaceWith(img);\n        }\n\n        // Capture scroll positions as attributes\n        if (realEl.scrollTop > 0) cloneEl.setAttribute('data-ta-scroll-top', realEl.scrollTop);\n        if (realEl.scrollLeft > 0) cloneEl.setAttribute('data-ta-scroll-left', realEl.scrollLeft);\n    });\n\n    // 3. Inject computed styles for reliability\n    // (Optional: can be heavy, but ensures visual fidelity)\n\n    return root.outerHTML;\n}\n","import { StruggleScore } from './StruggleScore.js';\nimport { NotificationSystem } from '../ui/NotificationSystem.js';\nimport { getElementSelector, isInteractiveElement } from '../utils/dom.js';\nimport { BehaviorEngine } from './BehaviorEngine.js';\nimport { captureDOMSnapshot } from '../utils/dom-snapshot.js';\n\n/**\n * Main TrapAlert Class\n */\nexport class TrapAlert {\n    constructor(config) {\n        if (!config || !config.tenantId || !config.collectorEndpoint) {\n            throw new Error('TrapAlert requires tenantId and collectorEndpoint');\n        }\n\n        this.tenantId = config.tenantId;\n        this.collectorEndpoint = config.collectorEndpoint.replace(/\\/+$/, '');\n        this.struggleScore = new StruggleScore();\n        this.behavioralTrace = [];\n        this.maxTraceLength = 20;\n\n        this.behaviorEngine = new BehaviorEngine(this.struggleScore);\n        this.behaviorEngine.onTrigger = () => {\n            this.lastTriggerTime = Date.now();\n        };\n\n        // Recording state\n        this.mediaRecorder = null;\n        this.recordedChunks = [];\n        this.domSnapshot = null;\n        this.triggerSnapshot = null;\n        this.domSnapshot = null;\n        this.triggerSnapshot = null;\n        this.audioContext = null;\n\n        // Watchers state\n        this.focusHistory = [];\n        this.escPressHistory = [];\n        this.lastProductiveTime = Date.now();\n        this.startTime = Date.now();\n        this.lastTriggerTime = Date.now();\n        this.activationThreshold = 100;\n        this.triggerLevel = 0; // 0: not triggered, 1: first trigger, 2: escalated trigger\n\n        // UI state\n        this.notificationShown = false;\n        this.ui = null;\n\n        this.init();\n    }\n\n    init() {\n        this.setupUI();\n        this.attachListeners();\n        this.startDecayTimer();\n        this.startVelocityGateMonitor();\n        console.log(`[TrapAlert] Initialized for tenant: ${this.tenantId}`);\n    }\n\n    startVelocityGateMonitor() {\n        setInterval(() => {\n            const now = Date.now();\n            const timeSinceStart = now - this.startTime;\n            const timeSinceLastTrigger = now - this.lastTriggerTime;\n\n            if (timeSinceStart > 600000 && timeSinceLastTrigger > 600000) {\n                // > 10 minutes (600,000 ms) without a trigger\n                if (this.activationThreshold === 100) { // Only increase once\n                    this.activationThreshold = 120; // Increase by 20%\n                    console.log('[TrapAlert] Velocity Gate: Increasing threshold to 120 for happy user.');\n                }\n            }\n        }, 60000); // Check every minute\n    }\n\n    setupUI() {\n        // 1. Inject Global Layout Shift Styles\n        const globalStyle = document.createElement('style');\n        globalStyle.textContent = `\n            body.trapalert-open {\n                margin-right: 350px;\n                transition: margin 0.3s ease;\n                overflow-x: hidden;\n            }\n            .ta-skip-link {\n                position: absolute;\n                top: -100px;\n                left: 0;\n                background: #1a1c2c;\n                color: white;\n                padding: 15px 25px;\n                z-index: 1000000;\n                text-decoration: none;\n                font-weight: bold;\n                border-bottom: 2px solid #fff;\n                transition: top 0.2s;\n            }\n            .ta-skip-link:focus {\n                top: 0;\n            }\n        `;\n        document.head.appendChild(globalStyle);\n\n        // 2. Inject Skip Link (Discovery for Screen Readers)\n        const skipLink = document.createElement('a');\n        skipLink.href = '#';\n        skipLink.className = 'ta-skip-link';\n        skipLink.textContent = 'Skip to Report Accessibility Issue with TrapAlert';\n        skipLink.addEventListener('click', (e) => {\n            e.preventDefault();\n            this.ui.show(this.struggleScore.get());\n        });\n        document.body.prepend(skipLink);\n\n        // 3. Setup Shadow DOM Container\n        const container = document.createElement('div');\n        container.id = 'trapalert-container';\n        container.setAttribute('aria-hidden', 'false');\n        document.body.appendChild(container);\n\n        const shadowRoot = container.attachShadow({ mode: 'open' });\n        this.ui = new NotificationSystem(\n            shadowRoot,\n            () => this.handleReport(),\n            () => this.handleDismiss()\n        );\n\n        // Bind recording handlers\n        this.ui.onStartRecording = this.handleStartRecording.bind(this);\n        this.ui.onStopRecording = this.handleStopRecording.bind(this);\n    }\n\n    async handleStartRecording() {\n        try {\n            // 1. Get Screen Stream FIRST (Critical for User Gesture validation in Firefox)\n            // Requesting audio: true in getDisplayMedia asks for System Audio\n            let screenStream;\n            try {\n                screenStream = await navigator.mediaDevices.getDisplayMedia({\n                    video: true,\n                    audio: true\n                });\n            } catch (err) {\n                console.error('[TrapAlert] Screen recording permission denied or cancelled:', err);\n                // Re-throw to trigger the main catch block with a specific message\n                throw new Error(`Screen recording permission denied: ${err.message}`);\n            }\n\n            // 2. Capture DOM Snapshot (can be done after stream is active)\n            if (this.triggerSnapshot) {\n                this.domSnapshot = this.triggerSnapshot;\n                console.log('[TrapAlert] Using Contextual DOM Snapshot (from trigger moment).');\n            } else {\n                this.domSnapshot = captureDOMSnapshot();\n                console.log('[TrapAlert] Captured fresh DOM Snapshot (no trigger context found).');\n            }\n\n            let combinedStream = screenStream;\n            let audioStream = null;\n\n            // 3. Request Microphone (attempt, but allow recording to continue if denied)\n            try {\n                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });\n                console.log('[TrapAlert] Microphone access granted.');\n            } catch (err) {\n                console.warn('[TrapAlert] Microphone access denied or not available:', err);\n            }\n\n            // Merge tracks using Web Audio API for reliable mixing\n            try {\n                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();\n                const dest = this.audioContext.createMediaStreamDestination();\n                let hasAudio = false;\n\n                // Add System Audio\n                if (screenStream.getAudioTracks().length > 0) {\n                    const source = this.audioContext.createMediaStreamSource(screenStream);\n                    source.connect(dest);\n                    console.log('[TrapAlert] Audio Mixing: Connected System Audio');\n                    hasAudio = true;\n                }\n\n                // Add Microphone Audio\n                if (audioStream && audioStream.getAudioTracks().length > 0) {\n                    const source = this.audioContext.createMediaStreamSource(audioStream);\n                    source.connect(dest);\n                    console.log('[TrapAlert] Audio Mixing: Connected Microphone');\n                    hasAudio = true;\n                }\n\n                const mixedTracks = dest.stream.getAudioTracks();\n\n                // Combine Video + Mixed Audio\n                const tracks = [\n                    ...screenStream.getVideoTracks(),\n                    ...(hasAudio ? mixedTracks : [])\n                ];\n\n                console.log(`[TrapAlert] Stream tracks: ${tracks.length} (Video: ${screenStream.getVideoTracks().length}, Audio: ${hasAudio ? 1 : 0})`);\n                combinedStream = new MediaStream(tracks);\n\n            } catch (e) {\n                console.error('[TrapAlert] Audio Context Error:', e);\n                // Fallback to simple merge if Web Audio fails\n                const tracks = [\n                    ...screenStream.getVideoTracks(),\n                    ...screenStream.getAudioTracks(),\n                    ...(audioStream ? audioStream.getAudioTracks() : [])\n                ];\n                combinedStream = new MediaStream(tracks);\n            }\n\n            // 3. Initialize MediaRecorder\n            this.recordedChunks = [];\n\n            // Check supported types\n            const mimeTypes = [\n                'video/webm;codecs=vp9,opus',\n                'video/webm;codecs=vp8,opus',\n                'video/webm',\n                'video/mp4'\n            ];\n\n            let selectedMimeType = '';\n            for (const type of mimeTypes) {\n                if (MediaRecorder.isTypeSupported(type)) {\n                    selectedMimeType = type;\n                    break;\n                }\n            }\n\n            console.log(`[TrapAlert] Using MIME type: ${selectedMimeType || 'default'}`);\n\n            const options = selectedMimeType ? { mimeType: selectedMimeType } : {};\n            this.mediaRecorder = new MediaRecorder(combinedStream, options);\n\n            this.mediaRecorder.ondataavailable = (event) => {\n                if (event.data.size > 0) {\n                    this.recordedChunks.push(event.data);\n                }\n            };\n\n            this.mediaRecorder.onstop = () => {\n                this.finalizeRecording();\n                // Stop all tracks to release hardware\n                combinedStream.getTracks().forEach(track => track.stop());\n            };\n\n            this.mediaRecorder.start();\n            this.ui.setRecordingState('recording');\n            console.log('[TrapAlert] Recording started.');\n\n\n        } catch (err) {\n            console.error('[TrapAlert] Failed to start recording:', err);\n            alert('Feedback Recording Error: Please ensure you grant Screen and Microphone permissions.');\n        }\n    }\n\n    handleStopRecording() {\n        if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {\n            this.mediaRecorder.stop();\n            this.ui.setRecordingState('uploading');\n        }\n        if (this.audioContext) {\n            this.audioContext.close();\n            this.audioContext = null;\n        }\n    }\n\n\n    async finalizeRecording() {\n        const videoBlob = new Blob(this.recordedChunks, { type: 'video/webm' });\n\n        const formData = new FormData();\n        formData.append('video', videoBlob, 'feedback-recording.webm');\n        formData.append('dom', this.domSnapshot);\n        formData.append('metadata', JSON.stringify(this.getBrowserMetadata()));\n        formData.append('struggleScore', this.struggleScore.get());\n        formData.append('description', this.ui.getDescription());\n        formData.append('tenantId', this.tenantId);\n\n        console.log(formData.get(\"transcript\"));\n\n        console.log('[TrapAlert] Dispatching multi-modal feedback...');\n\n        // Debug: Log payload details\n        console.log('[TrapAlert] Payload details:');\n        for (let [key, value] of formData.entries()) {\n            if (value instanceof Blob) {\n                console.log(`- ${key}: Binary Blob (${value.size} bytes, type: ${value.type})`);\n            } else {\n                console.log(`- ${key}: ${String(value).substring(0, 100)}${String(value).length > 100 ? '...' : ''}`);\n            }\n        }\n\n        try {\n            const response = await fetch(`${this.collectorEndpoint}/feedback`, {\n                method: 'POST',\n                body: formData\n            });\n\n            if (response.ok) {\n                console.log('[TrapAlert] Feedback uploaded successfully.');\n                this.ui.updateMessage('Feedback sent! Our engineers will audit this snapshot immediately.');\n            } else {\n                throw new Error('Upload failed');\n            }\n        } catch (err) {\n            console.error('[TrapAlert] Feedback upload failed:', err);\n            this.ui.updateMessage('Something went wrong during upload. Please try again.');\n        } finally {\n            setTimeout(() => {\n                this.ui.setRecordingState('idle');\n                this.struggleScore.reset();\n                this.domSnapshot = null;\n                this.triggerSnapshot = null;\n            }, 3000);\n        }\n    }\n\n    attachListeners() {\n        // Focus tracking\n        window.addEventListener('focusin', this.handleFocusIn.bind(this), true);\n        window.addEventListener('focusout', this.handleFocusOut.bind(this), true);\n\n        // Keyboard events\n        window.addEventListener('keydown', this.handleKeyDown.bind(this), true);\n\n        // Click events\n        window.addEventListener('click', this.handleClick.bind(this), true);\n\n        // Input events (productive behavior)\n        window.addEventListener('input', this.handleInput.bind(this), true);\n\n        // Alt+T shortcut for manual report\n        window.addEventListener('keydown', this.handleShortcut.bind(this), true);\n\n        // DOM Mutations (Error/Context Shift Detection)\n        this.observer = new MutationObserver(this.handleMutations.bind(this));\n        this.observer.observe(document.body, {\n            childList: true,\n            subtree: true,\n            attributes: true,\n            attributeFilter: ['role', 'aria-live', 'class', 'style']\n        });\n\n        // Tab Visibility tracking\n        window.addEventListener('visibilitychange', () => {\n            if (document.hidden) {\n                console.log('[TrapAlert] Tab hidden - resetting frustration engine');\n                this.struggleScore.reset();\n                this.triggerLevel = 0;\n                this.behaviorEngine.resetDeadEndTab();\n            }\n        });\n    }\n\n    handleMutations(mutations) {\n        // Notify behavior engine that something happened on the page\n        if (mutations.length > 0) {\n            this.behaviorEngine.registerMutation();\n        }\n\n        for (const mutation of mutations) {\n            if (mutation.type === 'childList') {\n                mutation.addedNodes.forEach(node => {\n                    if (node.nodeType === 1) { // Element node\n                        this.checkErrorNode(node);\n                    }\n                });\n            } else if (mutation.type === 'attributes') {\n                this.checkErrorNode(mutation.target);\n            }\n        }\n    }\n\n    checkErrorNode(node) {\n        if (!node.getAttribute) return;\n\n        const role = node.getAttribute('role');\n        const ariaLive = node.getAttribute('aria-live');\n\n        // Check for error markers\n        const isError = role === 'alert' ||\n            ariaLive === 'assertive' ||\n            (node.className && typeof node.className === 'string' && node.className.toLowerCase().includes('error'));\n\n        if (isError) {\n            console.log('[TrapAlert] Error message detected (DOM Mutation)');\n            this.behaviorEngine.registerContextShift(false);\n        }\n    }\n\n    handleFocusIn(event) {\n        const target = event.target;\n        const selector = getElementSelector(target);\n        const now = Date.now();\n\n        this.addToTrace('focusin', selector);\n\n        // Context tracking\n        this.focusHistory.push({\n            element: target,\n            selector: selector,\n            timestamp: now\n        });\n\n        // Prune focus history older than 60 seconds\n        this.focusHistory = this.focusHistory.filter(h => now - h.timestamp < 60000);\n\n        if (this.focusHistory.length > 20) {\n            this.focusHistory.shift();\n        }\n\n        // Analysis\n        this.behaviorEngine.handleFocus(target);\n        this.behaviorEngine.handleInputFocus(target);\n        this.checkThreshold();\n    }\n\n    handleFocusOut(event) {\n        this.behaviorEngine.handleInputBlur(event.target);\n        this.checkThreshold();\n    }\n\n    handleKeyDown(event) {\n        this.addToTrace('keydown', event.key);\n\n        if (event.key === 'Tab') {\n            this.behaviorEngine.handleTab();\n            this.checkThreshold();\n        }\n\n        if (event.key === 'Escape') {\n            this.handleEscapePress();\n        }\n    }\n\n    handleEscapePress() {\n        const now = Date.now();\n        this.escPressHistory.push(now);\n        this.escPressHistory = this.escPressHistory.filter(t => now - t < 3000);\n\n        if (this.escPressHistory.length >= 3) {\n            console.log('[TrapAlert] Rapid Escape presses detected');\n            this.struggleScore.add(50);\n            this.checkThreshold();\n            this.escPressHistory = [];\n        }\n    }\n\n    handleClick(event) {\n        const target = event.target;\n        const selector = getElementSelector(target);\n\n        this.addToTrace('click', selector);\n        this.markProductiveBehavior();\n\n        this.behaviorEngine.handleClick(target);\n        this.checkThreshold();\n    }\n\n    handleInput(event) {\n        this.addToTrace('input', getElementSelector(event.target));\n        this.markProductiveBehavior();\n        this.behaviorEngine.handleInputType(event.target);\n    }\n\n    markProductiveBehavior() {\n        this.lastProductiveTime = Date.now();\n        // Reset Dead-End Tab count on productive behavior\n        this.behaviorEngine.resetDeadEndTab();\n    }\n\n    handleShortcut(event) {\n        if (event.altKey && event.key === 't') {\n            event.preventDefault();\n            // Capture snapshot immediately on manual invocation\n            this.triggerSnapshot = captureDOMSnapshot();\n            console.log('[TrapAlert] Manual invocation: Contextual DOM Snapshot captured.');\n            this.ui.show(this.struggleScore.get());\n        }\n    }\n\n    startDecayTimer() {\n        // Every second for smooth bucket behavior\n        setInterval(() => {\n            this.struggleScore.decay();\n            if (this.notificationShown) {\n                this.ui.updateScore(this.struggleScore.get());\n            }\n        }, 1000);\n    }\n\n    addToTrace(type, detail) {\n        this.behavioralTrace.push({\n            type: type,\n            detail: detail,\n            timestamp: Date.now(),\n            url: window.location.href\n        });\n\n        if (this.behavioralTrace.length > this.maxTraceLength) {\n            this.behavioralTrace.shift();\n        }\n    }\n\n    checkThreshold() {\n        const score = this.struggleScore.get();\n        const firstLimit = this.activationThreshold;\n        const secondLimit = firstLimit * 2;\n\n        // Level 1: Initial Trigger\n        if (this.triggerLevel === 0 && score >= firstLimit) {\n            console.log(`[TrapAlert] Level 1 Trigger (Score: ${score}, Threshold: ${firstLimit})`);\n            // Capture snapshot immediately on first trigger\n            if (!this.triggerSnapshot) {\n                this.triggerSnapshot = captureDOMSnapshot();\n                console.log('[TrapAlert] Level 1 Trigger: Contextual DOM Snapshot captured.');\n            }\n            this.triggerLevel = 1;\n            this.notifyUser();\n        }\n        // Level 2: Escalation (2x Threshold)\n        else if (this.triggerLevel === 1 && score >= secondLimit) {\n            console.log(`[TrapAlert] Level 2 Escalation (Score: ${score}, Threshold: ${secondLimit})`);\n            this.triggerLevel = 2;\n            this.notifyUser();\n        }\n\n        // Reset Level if score drops significantly (e.g., back to near 0)\n        // This allows the cycle to restart if the user successfully recovers\n        if (score < 10 && this.triggerLevel !== 0) {\n            this.triggerLevel = 0;\n        }\n    }\n\n    notifyUser() {\n        if (this.notificationShown) return;\n        this.notificationShown = true;\n        this.ui.show(this.struggleScore.get());\n    }\n\n    handleDismiss() {\n        this.notificationShown = false;\n        // Optimization: We keep triggerLevel as is, so it only pops again at 2x threshold\n    }\n\n    handleReport() {\n        this.dispatchReport();\n        this.notificationShown = false;\n        this.struggleScore.reset();\n        this.notificationShown = false;\n        this.struggleScore.reset();\n        this.triggerLevel = 0; // Full reset on report\n        this.triggerSnapshot = null;\n    }\n\n    dispatchReport() {\n        const payload = {\n            tenantId: this.tenantId,\n            timestamp: new Date().toISOString(),\n            url: window.location.href,\n            struggleScore: this.struggleScore.get(),\n            description: this.ui.getDescription(),\n            behavioralTrace: this.behavioralTrace,\n            context: this.captureContext(),\n            metadata: this.getBrowserMetadata()\n        };\n\n        console.log('[TrapAlert] Dispatching report:', payload);\n\n        if (navigator.sendBeacon) {\n            const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });\n            const sent = navigator.sendBeacon(this.collectorEndpoint, blob);\n\n            if (!sent) {\n                this.fallbackFetch(payload);\n            }\n        } else {\n            this.fallbackFetch(payload);\n        }\n    }\n\n    fallbackFetch(payload) {\n        fetch(this.collectorEndpoint, {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify(payload),\n            keepalive: true\n        }).catch(err => {\n            console.error('[TrapAlert] Failed to send report:', err);\n        });\n    }\n\n    captureContext() {\n        const activeElement = document.activeElement;\n\n        return {\n            activeElement: {\n                selector: getElementSelector(activeElement),\n                outerHTML: activeElement ? activeElement.outerHTML : null,\n                tagName: activeElement ? activeElement.tagName : null,\n                role: activeElement ? activeElement.getAttribute('role') : null\n            },\n            focusHistory: this.focusHistory.map(h => ({\n                selector: h.selector,\n                timestamp: h.timestamp\n            })),\n            pageTitle: document.title,\n            scrollPosition: {\n                x: window.scrollX,\n                y: window.scrollY\n            }\n        };\n    }\n\n    getBrowserMetadata() {\n        return {\n            userAgent: navigator.userAgent,\n            screenSize: {\n                width: window.screen.width,\n                height: window.screen.height\n            },\n            viewportSize: {\n                width: window.innerWidth,\n                height: window.innerHeight\n            },\n            language: navigator.language,\n            platform: navigator.platform,\n            timestamp: Date.now()\n        };\n    }\n}\n","import { TrapAlert } from './core/TrapAlert.js';\n\n// Export for ES modules\nexport { TrapAlert };\n\n// Export for UMD/Browser\nif (typeof window !== 'undefined') {\n    window.TrapAlert = {\n        init: (config) => new TrapAlert(config)\n    };\n}\n"],"names":[],"mappings":"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"}