{"version":3,"file":"trapalert.umd.js","sources":["../src/core/StruggleScore.js","../src/ui/NotificationSystem.js","../src/utils/dom.js","../src/core/BehaviorEngine.js","../src/core/TrapAlert.js","../src/index.js"],"sourcesContent":["/**\n * StruggleScore - Manages the frustration meter (0-100)\n */\nexport class StruggleScore {\n    constructor(decayRate = 2) {\n        this.score = 0;\n        this.lastDecayTime = Date.now();\n        this.decayRate = decayRate; // points per second\n    }\n\n    setDecayRate(rate) {\n        this.decayRate = rate;\n    }\n\n    add(points) {\n        this.score = this.score + points;\n        return this.score;\n    }\n\n    subtract(points) {\n        this.score = Math.max(0, this.score - points);\n        return this.score;\n    }\n\n    decay() {\n        const now = Date.now();\n        const elapsed = (now - this.lastDecayTime) / 1000; // seconds\n\n        if (elapsed >= 1) {\n            const decayAmount = elapsed * this.decayRate;\n            this.subtract(decayAmount);\n            this.lastDecayTime = now;\n        }\n    }\n\n    get() {\n        return this.score;\n    }\n\n    reset() {\n        this.score = 0;\n        this.lastDecayTime = Date.now();\n    }\n}\n","export class NotificationSystem {\n    constructor(shadowRoot, onReport, onDismiss) {\n        this.shadowRoot = shadowRoot;\n        this.onReport = onReport;\n        this.onDismiss = onDismiss;\n        this.ariaLiveRegion = null;\n        this.initialize();\n    }\n\n    initialize() {\n        this.createAriaLiveRegion();\n        this.createSidebar();\n    }\n\n    createAriaLiveRegion() {\n        this.ariaLiveRegion = document.createElement('div');\n        this.ariaLiveRegion.setAttribute('role', 'status');\n        this.ariaLiveRegion.setAttribute('aria-live', 'assertive');\n        this.ariaLiveRegion.setAttribute('aria-atomic', 'true');\n        this.ariaLiveRegion.style.cssText = `\n      position: absolute;\n      left: -10000px;\n      width: 1px;\n      height: 1px;\n      overflow: hidden;\n    `;\n        this.shadowRoot.appendChild(this.ariaLiveRegion);\n    }\n\n    createSidebar() {\n        const style = document.createElement('style');\n        style.textContent = `\n      .trapalert-sidebar {\n        position: fixed;\n        top: 0;\n        right: -400px;\n        width: 350px;\n        height: 100vh;\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);\n        transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n        z-index: 999999;\n        color: white;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;\n        display: flex;\n        flex-direction: column;\n        padding: 30px 25px;\n        box-sizing: border-box;\n      }\n\n      .trapalert-sidebar.visible {\n        right: 0;\n      }\n\n      .trapalert-header {\n        font-size: 24px;\n        font-weight: 700;\n        margin-bottom: 15px;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n      }\n\n      .trapalert-icon {\n        width: 32px;\n        height: 32px;\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 8px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 20px;\n      }\n\n      .trapalert-message {\n        font-size: 16px;\n        line-height: 1.6;\n        margin-bottom: 25px;\n        opacity: 0.95;\n      }\n\n      .trapalert-score {\n        background: rgba(255, 255, 255, 0.15);\n        padding: 15px;\n        border-radius: 10px;\n        margin-bottom: 20px;\n        backdrop-filter: blur(10px);\n      }\n\n      .trapalert-score-label {\n        font-size: 12px;\n        text-transform: uppercase;\n        letter-spacing: 1px;\n        opacity: 0.8;\n        margin-bottom: 5px;\n      }\n\n      .trapalert-score-value {\n        font-size: 36px;\n        font-weight: 700;\n      }\n\n      .trapalert-button {\n        background: white;\n        color: #667eea;\n        border: none;\n        padding: 14px 24px;\n        border-radius: 8px;\n        font-size: 16px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s;\n        margin-bottom: 10px;\n      }\n\n      .trapalert-button:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n      }\n\n      .trapalert-button:active {\n        transform: translateY(0);\n      }\n\n      .trapalert-button-secondary {\n        background: transparent;\n        color: white;\n        border: 2px solid rgba(255, 255, 255, 0.3);\n      }\n\n      .trapalert-close {\n        position: absolute;\n        top: 20px;\n        right: 20px;\n        background: rgba(255, 255, 255, 0.2);\n        border: none;\n        color: white;\n        width: 32px;\n        height: 32px;\n        border-radius: 50%;\n        cursor: pointer;\n        font-size: 20px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: background 0.2s;\n      }\n\n      .trapalert-close:hover {\n        background: rgba(255, 255, 255, 0.3);\n      }\n    `;\n        this.shadowRoot.appendChild(style);\n\n        const sidebar = document.createElement('div');\n        sidebar.className = 'trapalert-sidebar';\n        sidebar.innerHTML = `\n      <button class=\"trapalert-close\" aria-label=\"Close notification\">×</button>\n      <div class=\"trapalert-header\">\n        <div class=\"trapalert-icon\">⚠️</div>\n        <span>TrapAlert</span>\n      </div>\n      <div class=\"trapalert-message\">\n        We've detected potential accessibility barriers on this page. Your feedback helps make the web better for everyone.\n      </div>\n      <div class=\"trapalert-score\">\n        <div class=\"trapalert-score-label\">Frustration Score</div>\n        <div class=\"trapalert-score-value\" id=\"score-display\">0</div>\n      </div>\n      <button class=\"trapalert-button\" id=\"report-btn\">\n        Report Accessibility Issue\n      </button>\n      <button class=\"trapalert-button trapalert-button-secondary\" id=\"dismiss-btn\">\n        Dismiss\n      </button>\n    `;\n        this.shadowRoot.appendChild(sidebar);\n\n        this.bindEvents();\n    }\n\n    bindEvents() {\n        const closeBtn = this.shadowRoot.querySelector('.trapalert-close');\n        const reportBtn = this.shadowRoot.querySelector('#report-btn');\n        const dismissBtn = this.shadowRoot.querySelector('#dismiss-btn');\n\n        closeBtn.addEventListener('click', () => this.hide());\n        dismissBtn.addEventListener('click', () => {\n            this.hide();\n            this.onDismiss();\n        });\n        reportBtn.addEventListener('click', () => {\n            this.onReport();\n            this.updateMessage('Thank you for reporting. Your feedback helps improve accessibility.');\n        });\n    }\n\n    show(score) {\n        const sidebar = this.shadowRoot.querySelector('.trapalert-sidebar');\n        if (sidebar) {\n            this.updateScore(score);\n            sidebar.classList.add('visible');\n            this.playNotificationSound();\n            this.announce('TrapAlert: Accessibility barrier detected. Press Alt+T to report.');\n        }\n    }\n\n    hide() {\n        const sidebar = this.shadowRoot.querySelector('.trapalert-sidebar');\n        if (sidebar) {\n            sidebar.classList.remove('visible');\n        }\n    }\n\n    updateScore(score) {\n        const scoreDisplay = this.shadowRoot.querySelector('#score-display');\n        if (scoreDisplay) {\n            scoreDisplay.textContent = Math.round(score);\n        }\n    }\n\n    announce(message) {\n        if (this.ariaLiveRegion) {\n            this.ariaLiveRegion.textContent = message;\n        }\n    }\n\n    updateMessage(message) {\n        this.announce(message);\n        const messageEl = this.shadowRoot.querySelector('.trapalert-message');\n        if (messageEl) {\n            messageEl.textContent = message;\n        }\n    }\n\n    playNotificationSound() {\n        // Base64 encoded short beep sound (data URI)\n        const audioData = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6foKGio6SlpqeoqaqrrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfY2drb3N3e3+Dh4uPk5ebn6Onq6+zt7u/w8fLz9PX29/j5+vv8/f7/AAECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w==';\n\n        try {\n            const audio = new Audio(audioData);\n            audio.volume = 0.3;\n            audio.play().catch(err => {\n                console.warn('[TrapAlert] Could not play notification sound:', err);\n            });\n        } catch (err) {\n            console.warn('[TrapAlert] Audio not supported:', err);\n        }\n    }\n}\n","/**\n * Get CSS selector for element\n * @param {HTMLElement} element \n * @returns {string} Unique-ish selector\n */\nexport function getElementSelector(element) {\n    if (!element || element === document) return 'document';\n    if (element === window) return 'window';\n\n    if (element.id) {\n        return `#${element.id}`;\n    }\n\n    if (element.className && typeof element.className === 'string') {\n        const classes = element.className.trim().split(/\\s+/).join('.');\n        if (classes) {\n            return `${element.tagName.toLowerCase()}.${classes}`;\n        }\n    }\n\n    return element.tagName.toLowerCase();\n}\n\n/**\n * Check if element is interactive\n * @param {HTMLElement} element \n * @returns {boolean}\n */\nexport function isInteractiveElement(element) {\n    const tagName = element.tagName.toLowerCase();\n    const interactiveTags = ['a', 'button', 'input', 'select', 'textarea'];\n\n    if (interactiveTags.includes(tagName)) return true;\n    if (element.hasAttribute('onclick')) return true;\n    if (element.getAttribute('role') === 'button') return true;\n    if (element.hasAttribute('href')) return true;\n    if (element.hasAttribute('tabindex') && element.getAttribute('tabindex') !== '-1') return true;\n\n    return false;\n}\n\n/**\n * Check if element has pointer cursor\n * @param {HTMLElement} element \n * @returns {boolean}\n */\nexport function hasPointerCursor(element) {\n    try {\n        const style = window.getComputedStyle(element);\n        return style.cursor === 'pointer';\n    } catch (e) {\n        return false;\n    }\n}\n\n/**\n * Get simple XPath for element\n * @param {HTMLElement} element \n * @returns {string}\n */\nexport function getElementXPath(element) {\n    if (element.id !== '') return `//*[@id=\"${element.id}\"]`;\n    if (element === document.body) return '/html/body';\n\n    let ix = 0;\n    const siblings = element.parentNode ? element.parentNode.childNodes : [];\n\n    for (let i = 0; i < siblings.length; i++) {\n        const sibling = siblings[i];\n        if (sibling === element) {\n            return getElementXPath(element.parentNode) + '/' + element.tagName.toLowerCase() + '[' + (ix + 1) + ']';\n        }\n        if (sibling.nodeType === 1 && sibling.tagName === element.tagName) {\n            ix++;\n        }\n    }\n    return '';\n}\n","import { getElementSelector, hasPointerCursor, getElementXPath } from '../utils/dom.js';\n\n/**\n * BehaviorEngine - Advanced logic for detecting struggle vs power usage\n */\nexport class BehaviorEngine {\n    constructor(struggleScore) {\n        this.struggleScore = struggleScore;\n\n        // Efficiency Ratio State\n        this.focusBuffer = []; // stores { id, xpath }\n        this.maxFocusBuffer = 20;\n\n        // U-Turn State\n        this.navigationHistory = []; // stores selector strings\n        this.maxNavHistory = 10;\n\n        // Rage Click State\n        this.clickHistory = new Map(); // selector -> [timestamps]\n\n        // Dead-End Tab State\n        this.tabCount = 0;\n        this.lastProductiveAction = Date.now();\n\n        // Input Abandonment State\n        this.currentInputObj = null; // { element, startLen, maxLen, typed }\n\n        // Advanced Heuristics State\n        this.momentumEndsAt = 0; // Timestamp when success momentum buffer ends\n        this.sensitivityMultiplier = 1; // Default sensitivity\n        this.sensitivityEndsAt = 0; // Timestamp when high sensitivity ends\n        this.interactedElements = new Set(); // Selectors of elements user has productively interacted with\n        this.focusClusterBuffer = []; // stores { x, y } for cluster analysis\n    }\n\n    /**\n     * Helper to add score with momentum and sensitivity applied\n     */\n    addScore(points, reason) {\n        const now = Date.now();\n        let finalPoints = points;\n\n        // Mark trigger for velocity gate\n        if (this.onTrigger) this.onTrigger();\n\n        // Apply Sensitivity Multiplier\n        if (now < this.sensitivityEndsAt) {\n            finalPoints *= this.sensitivityMultiplier;\n        }\n\n        // Apply Success Momentum (Buffer)\n        // Bypass buffer for Rage Clicks or serious context sensitivity\n        const isFrustrationMarker = points >= 60 || reason === 'Rage Click';\n\n        if (now < this.momentumEndsAt && !isFrustrationMarker) {\n            // Buffer reduces increments by 80%\n            finalPoints *= 0.2;\n        }\n\n        finalPoints = Math.round(finalPoints);\n\n        if (finalPoints > 0) {\n            console.log(`[BehaviorEngine] Adding ${finalPoints} points (${reason}). Base: ${points}, Sens: ${this.sensitivityMultiplier}, Mom: ${now < this.momentumEndsAt}`);\n            this.struggleScore.add(finalPoints);\n        }\n    }\n\n    /**\n     * Register a successful action (typing, clicking, navigating)\n     */\n    registerSuccess() {\n        this.momentumEndsAt = Date.now() + 5000; // 5 second buffer\n        this.resetDeadEndTab();\n        this.uTurnCounter = 0; // Reset grace period on success\n\n        // High decay rate during momentum\n        this.struggleScore.setDecayRate(10);\n\n        // Instant drain\n        this.struggleScore.subtract(10);\n\n        // Revert decay rate after 5 seconds\n        if (this.decayRevertTimeout) clearTimeout(this.decayRevertTimeout);\n        this.decayRevertTimeout = setTimeout(() => {\n            this.struggleScore.setDecayRate(2);\n        }, 5000);\n    }\n\n    /**\n     * Register a high-risk context shift (error message, submit click)\n     */\n    registerContextShift(isSubmit = false) {\n        // Clear momentum immediately\n        this.momentumEndsAt = 0;\n        this.uTurnCounter = 0; // Reset for fresh state\n\n        // Increase sensitivity\n        this.sensitivityMultiplier = 2;\n        this.sensitivityEndsAt = Date.now() + 30000; // 30 seconds\n\n        console.log(`[BehaviorEngine] Context Shift! Sensitivity doubled. Submit: ${isSubmit}`);\n    }\n\n    /**\n     * Process focusin events for Efficiency Ratio & U-Turn\n     */\n    handleFocus(element) {\n        const selector = getElementSelector(element);\n        const xpath = getElementXPath(element);\n        const id = element.id || null;\n        const now = Date.now();\n\n        // 0. History Pruning: Remove events older than 60 seconds\n        this.pruneHistory(now);\n\n        // Check if previously interacted (Interaction History)\n        if (this.interactedElements.has(selector)) {\n            // Do not penalize re-focusing inputs they already worked on\n            return;\n        }\n\n        // 1. Efficiency Ratio Buffer update\n        this.focusBuffer.push({ id, xpath, timestamp: now });\n        if (this.focusBuffer.length > this.maxFocusBuffer) {\n            this.focusBuffer.shift();\n        }\n\n        // 2. Cluster-Loop Detection\n        const rect = element.getBoundingClientRect();\n        this.focusClusterBuffer.push({\n            x: rect.left,\n            y: rect.top,\n            selector: selector,\n            timestamp: now\n        });\n        if (this.focusClusterBuffer.length > 5) this.focusClusterBuffer.shift();\n\n        this.detectClusterLoop();\n\n        this.evaluateEfficiency();\n\n        // 3. U-Turn Detection\n        this.navigationHistory.push(selector);\n        if (this.navigationHistory.length > this.maxNavHistory) {\n            this.navigationHistory.shift();\n        }\n        this.detectUTurn();\n    }\n\n    pruneHistory(now) {\n        const threshold = 60000; // 60 seconds\n        this.focusBuffer = this.focusBuffer.filter(item => now - item.timestamp < threshold);\n        this.focusClusterBuffer = this.focusClusterBuffer.filter(item => now - item.timestamp < threshold);\n    }\n\n    detectClusterLoop() {\n        if (this.focusClusterBuffer.length < 5) return;\n\n        // Visual Distance Check: Are all 5 points within a 300px box?\n        const xs = this.focusClusterBuffer.map(p => p.x);\n        const ys = this.focusClusterBuffer.map(p => p.y);\n\n        const minX = Math.min(...xs);\n        const maxX = Math.max(...xs);\n        const minY = Math.min(...ys);\n        const maxY = Math.max(...ys);\n\n        const width = maxX - minX;\n        const height = maxY - minY;\n\n        if (width < 300 && height < 300) {\n            // Check for repetition within the cluster (avoid flagging toolbars)\n            const selectors = this.focusClusterBuffer.map(p => p.selector);\n            const uniqueInCluster = new Set(selectors).size;\n\n            // If we have 5 events but only 1 or 2 unique elements, we are vibrating in place\n            // (U-Turn logic handles 3-element patterns like A-B-C-B-A better)\n            if (uniqueInCluster < 3) {\n                console.log('[BehaviorEngine] Localized Trap (Cluster) detected');\n                this.addScore(10, 'Localized Trap');\n            }\n        }\n    }\n\n    /**\n     * \"Efficiency Ratio\" Logic\n     */\n    evaluateEfficiency() {\n        const totalEvents = this.focusBuffer.length;\n        if (totalEvents < 8) return; // Wait for a more robust sample (was 5)\n\n        // Definition of Unique Focus: The count of unique id or xpath attributes\n        const uniqueKeys = new Set(this.focusBuffer.map(item => item.id || item.xpath));\n        const uniqueCount = uniqueKeys.size;\n\n        const efficiency = uniqueCount / totalEvents;\n\n        // Behavioral Trigger\n        if (efficiency < 0.25) { // Slightly more strict (was 0.3)\n            // User is hitting the same 4-5 elements repeatedly\n            this.addScore(5, 'Low Efficiency');\n        } else if (efficiency > 0.8) {\n            // Power User Protection\n            // Decrease Struggle Score by -20 points\n            // Note: Limit frequency of this reward or check if we just crossed the threshold?\n            // \"Decrease Struggle Score by -20 points (Power User Protection)\" implies a one-time bonus or periodic?\n            // \"per event\" isn't specified for the bonus, but typically power user behavior is continuous.\n            // If we subtract 20 on EVERY focus event, score will stay 0. That's probably intended.\n            // If exploring effectively, we shouldn't count \"Dead-End Tabs\"\n            this.resetDeadEndTab();\n\n            if (this.struggleScore.get() > 0) {\n                this.struggleScore.subtract(20);\n            }\n        }\n    }\n\n    /**\n     * \"The U-Turn\" Logic\n     * A -> B -> C -> B -> A\n     */\n    detectUTurn() {\n        if (this.navigationHistory.length < 5) return;\n\n        const h = this.navigationHistory;\n        const len = h.length;\n\n        // A -> B -> C -> B -> A\n        // A=idx-4, B=idx-3, C=idx-2, B=idx-1, A=idx\n        const A1 = h[len - 5];\n        const B1 = h[len - 4];\n        const C = h[len - 3];\n        const B2 = h[len - 2];\n        const A2 = h[len - 1];\n\n        if (A1 === A2 && B1 === B2 && A1 !== B1 && B1 !== C) {\n            // First U-Turn is often a valid correction.\n            // Only penalize if they've done it recently or are in a sensitive state.\n            this.uTurnCounter = (this.uTurnCounter || 0) + 1;\n\n            if (this.uTurnCounter > 1) {\n                console.log('[BehaviorEngine] Repeated U-Turn detected');\n                this.addScore(20, 'Repeated U-Turn'); // Reduced from 30\n            } else {\n                console.log('[BehaviorEngine] Intentional U-Turn (Normalization)');\n                // If it's a one-off, we grant a \"grace\" score\n                this.addScore(5, 'Minor Backtrack');\n            }\n\n            // Clear history and reset counter if they start moving again\n            this.navigationHistory = [];\n        }\n    }\n\n    /**\n     * \"Rage Clicking\" Logic\n     */\n    handleClick(element) {\n        const selector = getElementSelector(element);\n        const now = Date.now();\n\n        const hasPointer = hasPointerCursor(element);\n        const likelyInteractive = ['a', 'button', 'input', 'select', 'textarea'].includes(element.tagName.toLowerCase())\n            || element.hasAttribute('onclick')\n            || element.getAttribute('role') === 'button';\n\n        // 1. Success Verification: Don't give momentum until we see a result (mutation)\n        if (likelyInteractive || hasPointer) {\n            this.pendingSuccess = {\n                timestamp: now,\n                type: 'click',\n                selector: selector\n            };\n            // We'll wait for a mutation to confirm\n            setTimeout(() => {\n                if (this.pendingSuccess && this.pendingSuccess.timestamp === now) {\n                    this.pendingSuccess = null; // Expired\n                }\n            }, 1000);\n        }\n\n        // Track interaction for history\n        if (['input', 'textarea', 'select'].includes(element.tagName.toLowerCase())) {\n            this.interactedElements.add(selector);\n        }\n\n        // Check for Submit button click\n        if (element.getAttribute('type') === 'submit' || element.getAttribute('role') === 'button') {\n            this.registerContextShift(true);\n        }\n\n        if (!this.clickHistory.has(selector)) {\n            this.clickHistory.set(selector, []);\n        }\n\n        const clicks = this.clickHistory.get(selector);\n        clicks.push(now);\n\n        const recentClicks = clicks.filter(t => now - t < 2000);\n        this.clickHistory.set(selector, recentClicks);\n\n        if (recentClicks.length > 5) {\n            if (!hasPointer && !likelyInteractive) {\n                // Rage clicking on static text\n                this.addScore(60, 'Rage Click (Static)');\n                this.clickHistory.delete(selector);\n            } else {\n                // Rage clicking on a BUTTON (Possible Dead-End/Broken Button)\n                // This answers: \"what if the button is not working?\"\n                console.log('[BehaviorEngine] Potential Broken Button / Dead-End Click sequence');\n                this.addScore(40, 'Button Mashing'); // Serious frustration but potentially valid (just slow)\n                this.clickHistory.delete(selector);\n            }\n        }\n    }\n\n    /**\n     * Called by TrapAlert when a DOM mutation is detected\n     */\n    registerMutation() {\n        if (this.pendingSuccess) {\n            console.log(`[BehaviorEngine] Click on ${this.pendingSuccess.selector} verified by DOM mutation. Registering Success.`);\n            this.registerSuccess();\n            this.pendingSuccess = null;\n        }\n    }\n\n    /**\n     * \"The Dead-End Tab\"\n     * >15 tabs without a single change (or while stuck).\n     * If handled in handleFocus via efficiency resets, this just catches\n     * pure rapid tabbing without focus change (rare) OR low-efficiency tabbing.\n     */\n    handleTab() {\n        // We defer penalty. If the user tabs 15 times but Efficiency is High, evaluateEfficiency resets this.\n        // If Efficiency is Low (Looping), this accumulates and penalizes ON TOP of Efficiency penalties.\n        this.tabCount++;\n        if (this.tabCount > 15) {\n            this.addScore(40, 'Dead-End Tab');\n            this.tabCount = 0;\n        }\n    }\n\n    resetDeadEndTab() {\n        this.tabCount = 0;\n    }\n\n    /**\n     * \"Input Abandonment\"\n     * User clicks an input, types <3 chars, deletes them, and tabs away.\n     */\n    handleInputFocus(element) {\n        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {\n            this.currentInputObj = {\n                element: element,\n                startValue: element.value,\n                maxLenReached: element.value.length,\n                typed: false\n            };\n        }\n    }\n\n    handleInputType(element) {\n        this.registerSuccess();\n\n        if (this.currentInputObj && this.currentInputObj.element === element) {\n            this.currentInputObj.typed = true;\n            this.interactedElements.add(getElementSelector(element)); // Mark as Productive Interaction\n\n            if (element.value.length > this.currentInputObj.maxLenReached) {\n                this.currentInputObj.maxLenReached = element.value.length;\n            }\n        }\n    }\n\n    handleInputBlur(element) {\n        if (this.currentInputObj && this.currentInputObj.element === element) {\n            const finalLen = element.value.length;\n            const startLen = this.currentInputObj.startValue.length;\n            const charsAdded = this.currentInputObj.maxLenReached - startLen; // rough approximation of \"typed\"\n\n            // \"types <3 chars, deletes them (so back to start or empty), and tabs away (blur)\"\n            // Simplification: Check if they typed something small and then cleared/reverted it.\n            const wasEdited = this.currentInputObj.typed;\n            const reverted = finalLen <= startLen; // Or strictly empty? \"deletes them\" triggers usually mean empty or original state\n            const smallEffort = charsAdded > 0 && charsAdded < 3;\n\n            if (wasEdited && smallEffort && reverted) {\n                this.addScore(20, 'Input Abandonment');\n            }\n\n            this.currentInputObj = null;\n        }\n    }\n}\n","import { StruggleScore } from './StruggleScore.js';\nimport { NotificationSystem } from '../ui/NotificationSystem.js';\nimport { getElementSelector, isInteractiveElement } from '../utils/dom.js';\nimport { BehaviorEngine } from './BehaviorEngine.js';\n\n/**\n * Main TrapAlert Class\n */\nexport class TrapAlert {\n    constructor(config) {\n        if (!config || !config.tenantId || !config.collectorEndpoint) {\n            throw new Error('TrapAlert requires tenantId and collectorEndpoint');\n        }\n\n        this.tenantId = config.tenantId;\n        this.collectorEndpoint = config.collectorEndpoint;\n        this.struggleScore = new StruggleScore();\n        this.behavioralTrace = [];\n        this.maxTraceLength = 20;\n\n        this.behaviorEngine = new BehaviorEngine(this.struggleScore);\n        this.behaviorEngine.onTrigger = () => {\n            this.lastTriggerTime = Date.now();\n        };\n\n        // Watchers state\n        this.focusHistory = [];\n        this.escPressHistory = [];\n        this.lastProductiveTime = Date.now();\n        this.startTime = Date.now();\n        this.lastTriggerTime = Date.now();\n        this.activationThreshold = 100;\n        this.triggerLevel = 0; // 0: not triggered, 1: first trigger, 2: escalated trigger\n\n        // UI state\n        this.notificationShown = false;\n        this.ui = null;\n\n        this.init();\n    }\n\n    init() {\n        this.setupUI();\n        this.attachListeners();\n        this.startDecayTimer();\n        this.startVelocityGateMonitor();\n        console.log(`[TrapAlert] Initialized for tenant: ${this.tenantId}`);\n    }\n\n    startVelocityGateMonitor() {\n        setInterval(() => {\n            const now = Date.now();\n            const timeSinceStart = now - this.startTime;\n            const timeSinceLastTrigger = now - this.lastTriggerTime;\n\n            if (timeSinceStart > 600000 && timeSinceLastTrigger > 600000) {\n                // > 10 minutes (600,000 ms) without a trigger\n                if (this.activationThreshold === 100) { // Only increase once\n                    this.activationThreshold = 120; // Increase by 20%\n                    console.log('[TrapAlert] Velocity Gate: Increasing threshold to 120 for happy user.');\n                }\n            }\n        }, 60000); // Check every minute\n    }\n\n    setupUI() {\n        const container = document.createElement('div');\n        container.id = 'trapalert-container';\n        container.setAttribute('aria-hidden', 'false');\n        document.body.appendChild(container);\n\n        const shadowRoot = container.attachShadow({ mode: 'open' });\n        this.ui = new NotificationSystem(\n            shadowRoot,\n            () => this.handleReport(),\n            () => this.handleDismiss()\n        );\n    }\n\n    attachListeners() {\n        // Focus tracking\n        window.addEventListener('focusin', this.handleFocusIn.bind(this), true);\n        window.addEventListener('focusout', this.handleFocusOut.bind(this), true);\n\n        // Keyboard events\n        window.addEventListener('keydown', this.handleKeyDown.bind(this), true);\n\n        // Click events\n        window.addEventListener('click', this.handleClick.bind(this), true);\n\n        // Input events (productive behavior)\n        window.addEventListener('input', this.handleInput.bind(this), true);\n\n        // Alt+T shortcut for manual report\n        window.addEventListener('keydown', this.handleShortcut.bind(this), true);\n\n        // DOM Mutations (Error/Context Shift Detection)\n        this.observer = new MutationObserver(this.handleMutations.bind(this));\n        this.observer.observe(document.body, {\n            childList: true,\n            subtree: true,\n            attributes: true,\n            attributeFilter: ['role', 'aria-live', 'class', 'style']\n        });\n\n        // Tab Visibility tracking\n        window.addEventListener('visibilitychange', () => {\n            if (document.hidden) {\n                console.log('[TrapAlert] Tab hidden - resetting frustration engine');\n                this.struggleScore.reset();\n                this.triggerLevel = 0;\n                this.behaviorEngine.resetDeadEndTab();\n            }\n        });\n    }\n\n    handleMutations(mutations) {\n        // Notify behavior engine that something happened on the page\n        if (mutations.length > 0) {\n            this.behaviorEngine.registerMutation();\n        }\n\n        for (const mutation of mutations) {\n            if (mutation.type === 'childList') {\n                mutation.addedNodes.forEach(node => {\n                    if (node.nodeType === 1) { // Element node\n                        this.checkErrorNode(node);\n                    }\n                });\n            } else if (mutation.type === 'attributes') {\n                this.checkErrorNode(mutation.target);\n            }\n        }\n    }\n\n    checkErrorNode(node) {\n        if (!node.getAttribute) return;\n\n        const role = node.getAttribute('role');\n        const ariaLive = node.getAttribute('aria-live');\n\n        // Check for error markers\n        const isError = role === 'alert' ||\n            ariaLive === 'assertive' ||\n            (node.className && typeof node.className === 'string' && node.className.toLowerCase().includes('error'));\n\n        if (isError) {\n            console.log('[TrapAlert] Error message detected (DOM Mutation)');\n            this.behaviorEngine.registerContextShift(false);\n        }\n    }\n\n    handleFocusIn(event) {\n        const target = event.target;\n        const selector = getElementSelector(target);\n        const now = Date.now();\n\n        this.addToTrace('focusin', selector);\n\n        // Context tracking\n        this.focusHistory.push({\n            element: target,\n            selector: selector,\n            timestamp: now\n        });\n\n        // Prune focus history older than 60 seconds\n        this.focusHistory = this.focusHistory.filter(h => now - h.timestamp < 60000);\n\n        if (this.focusHistory.length > 20) {\n            this.focusHistory.shift();\n        }\n\n        // Analysis\n        this.behaviorEngine.handleFocus(target);\n        this.behaviorEngine.handleInputFocus(target);\n        this.checkThreshold();\n    }\n\n    handleFocusOut(event) {\n        this.behaviorEngine.handleInputBlur(event.target);\n        this.checkThreshold();\n    }\n\n    handleKeyDown(event) {\n        this.addToTrace('keydown', event.key);\n\n        if (event.key === 'Tab') {\n            this.behaviorEngine.handleTab();\n            this.checkThreshold();\n        }\n\n        if (event.key === 'Escape') {\n            this.handleEscapePress();\n        }\n    }\n\n    handleEscapePress() {\n        const now = Date.now();\n        this.escPressHistory.push(now);\n        this.escPressHistory = this.escPressHistory.filter(t => now - t < 3000);\n\n        if (this.escPressHistory.length >= 3) {\n            console.log('[TrapAlert] Rapid Escape presses detected');\n            this.struggleScore.add(50);\n            this.checkThreshold();\n            this.escPressHistory = [];\n        }\n    }\n\n    handleClick(event) {\n        const target = event.target;\n        const selector = getElementSelector(target);\n\n        this.addToTrace('click', selector);\n        this.markProductiveBehavior();\n\n        this.behaviorEngine.handleClick(target);\n        this.checkThreshold();\n    }\n\n    handleInput(event) {\n        this.addToTrace('input', getElementSelector(event.target));\n        this.markProductiveBehavior();\n        this.behaviorEngine.handleInputType(event.target);\n    }\n\n    markProductiveBehavior() {\n        this.lastProductiveTime = Date.now();\n        // Reset Dead-End Tab count on productive behavior\n        this.behaviorEngine.resetDeadEndTab();\n    }\n\n    handleShortcut(event) {\n        if (event.altKey && event.key === 't') {\n            event.preventDefault();\n            this.ui.show(this.struggleScore.get());\n        }\n    }\n\n    startDecayTimer() {\n        // Every second for smooth bucket behavior\n        setInterval(() => {\n            this.struggleScore.decay();\n            if (this.notificationShown) {\n                this.ui.updateScore(this.struggleScore.get());\n            }\n        }, 1000);\n    }\n\n    addToTrace(type, detail) {\n        this.behavioralTrace.push({\n            type: type,\n            detail: detail,\n            timestamp: Date.now(),\n            url: window.location.href\n        });\n\n        if (this.behavioralTrace.length > this.maxTraceLength) {\n            this.behavioralTrace.shift();\n        }\n    }\n\n    checkThreshold() {\n        const score = this.struggleScore.get();\n        const firstLimit = this.activationThreshold;\n        const secondLimit = firstLimit * 2;\n\n        // Level 1: Initial Trigger\n        if (this.triggerLevel === 0 && score >= firstLimit) {\n            console.log(`[TrapAlert] Level 1 Trigger (Score: ${score}, Threshold: ${firstLimit})`);\n            this.triggerLevel = 1;\n            this.notifyUser();\n        }\n        // Level 2: Escalation (2x Threshold)\n        else if (this.triggerLevel === 1 && score >= secondLimit) {\n            console.log(`[TrapAlert] Level 2 Escalation (Score: ${score}, Threshold: ${secondLimit})`);\n            this.triggerLevel = 2;\n            this.notifyUser();\n        }\n\n        // Reset Level if score drops significantly (e.g., back to near 0)\n        // This allows the cycle to restart if the user successfully recovers\n        if (score < 10 && this.triggerLevel !== 0) {\n            this.triggerLevel = 0;\n        }\n    }\n\n    notifyUser() {\n        if (this.notificationShown) return;\n        this.notificationShown = true;\n        this.ui.show(this.struggleScore.get());\n    }\n\n    handleDismiss() {\n        this.notificationShown = false;\n        // Optimization: We keep triggerLevel as is, so it only pops again at 2x threshold\n    }\n\n    handleReport() {\n        this.dispatchReport();\n        this.notificationShown = false;\n        this.struggleScore.reset();\n        this.triggerLevel = 0; // Full reset on report\n    }\n\n    dispatchReport() {\n        const payload = {\n            tenantId: this.tenantId,\n            timestamp: new Date().toISOString(),\n            url: window.location.href,\n            struggleScore: this.struggleScore.get(),\n            behavioralTrace: this.behavioralTrace,\n            context: this.captureContext(),\n            metadata: this.getBrowserMetadata()\n        };\n\n        console.log('[TrapAlert] Dispatching report:', payload);\n\n        if (navigator.sendBeacon) {\n            const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });\n            const sent = navigator.sendBeacon(this.collectorEndpoint, blob);\n\n            if (!sent) {\n                this.fallbackFetch(payload);\n            }\n        } else {\n            this.fallbackFetch(payload);\n        }\n    }\n\n    fallbackFetch(payload) {\n        fetch(this.collectorEndpoint, {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify(payload),\n            keepalive: true\n        }).catch(err => {\n            console.error('[TrapAlert] Failed to send report:', err);\n        });\n    }\n\n    captureContext() {\n        const activeElement = document.activeElement;\n\n        return {\n            activeElement: {\n                selector: getElementSelector(activeElement),\n                outerHTML: activeElement ? activeElement.outerHTML : null,\n                tagName: activeElement ? activeElement.tagName : null,\n                role: activeElement ? activeElement.getAttribute('role') : null\n            },\n            focusHistory: this.focusHistory.map(h => ({\n                selector: h.selector,\n                timestamp: h.timestamp\n            })),\n            pageTitle: document.title,\n            scrollPosition: {\n                x: window.scrollX,\n                y: window.scrollY\n            }\n        };\n    }\n\n    getBrowserMetadata() {\n        return {\n            userAgent: navigator.userAgent,\n            screenSize: {\n                width: window.screen.width,\n                height: window.screen.height\n            },\n            viewportSize: {\n                width: window.innerWidth,\n                height: window.innerHeight\n            },\n            language: navigator.language,\n            platform: navigator.platform,\n            timestamp: Date.now()\n        };\n    }\n}\n","import { TrapAlert } from './core/TrapAlert.js';\n\n// Export for ES modules\nexport { TrapAlert };\n\n// Export for UMD/Browser\nif (typeof window !== 'undefined') {\n    window.TrapAlert = {\n        init: (config) => new TrapAlert(config)\n    };\n}\n"],"names":["StruggleScore","constructor","decayRate","this","score","lastDecayTime","Date","now","setDecayRate","rate","add","points","subtract","Math","max","decay","elapsed","decayAmount","get","reset","NotificationSystem","shadowRoot","onReport","onDismiss","ariaLiveRegion","initialize","createAriaLiveRegion","createSidebar","document","createElement","setAttribute","style","cssText","appendChild","textContent","sidebar","className","innerHTML","bindEvents","closeBtn","querySelector","reportBtn","dismissBtn","addEventListener","hide","updateMessage","show","updateScore","classList","playNotificationSound","announce","remove","scoreDisplay","round","message","messageEl","audio","Audio","volume","play","catch","err","console","warn","getElementSelector","element","window","id","classes","trim","split","join","tagName","toLowerCase","getElementXPath","body","ix","siblings","parentNode","childNodes","i","length","sibling","nodeType","BehaviorEngine","struggleScore","focusBuffer","maxFocusBuffer","navigationHistory","maxNavHistory","clickHistory","Map","tabCount","lastProductiveAction","currentInputObj","momentumEndsAt","sensitivityMultiplier","sensitivityEndsAt","interactedElements","Set","focusClusterBuffer","addScore","reason","finalPoints","onTrigger","isFrustrationMarker","log","registerSuccess","resetDeadEndTab","uTurnCounter","decayRevertTimeout","clearTimeout","setTimeout","registerContextShift","isSubmit","handleFocus","selector","xpath","pruneHistory","has","push","timestamp","shift","rect","getBoundingClientRect","x","left","y","top","detectClusterLoop","evaluateEfficiency","detectUTurn","filter","item","xs","map","p","ys","minX","min","maxX","minY","maxY","selectors","size","totalEvents","efficiency","h","len","A1","B1","C","B2","handleClick","hasPointer","getComputedStyle","cursor","e","hasPointerCursor","likelyInteractive","includes","hasAttribute","getAttribute","pendingSuccess","type","set","clicks","recentClicks","t","delete","registerMutation","handleTab","handleInputFocus","startValue","value","maxLenReached","typed","handleInputType","handleInputBlur","finalLen","startLen","charsAdded","TrapAlert","config","tenantId","collectorEndpoint","Error","behavioralTrace","maxTraceLength","behaviorEngine","lastTriggerTime","focusHistory","escPressHistory","lastProductiveTime","startTime","activationThreshold","triggerLevel","notificationShown","ui","init","setupUI","attachListeners","startDecayTimer","startVelocityGateMonitor","setInterval","timeSinceStart","timeSinceLastTrigger","container","attachShadow","mode","handleReport","handleDismiss","handleFocusIn","bind","handleFocusOut","handleKeyDown","handleInput","handleShortcut","observer","MutationObserver","handleMutations","observe","childList","subtree","attributes","attributeFilter","hidden","mutations","mutation","addedNodes","forEach","node","checkErrorNode","target","role","ariaLive","event","addToTrace","checkThreshold","key","handleEscapePress","markProductiveBehavior","altKey","preventDefault","detail","url","location","href","firstLimit","secondLimit","notifyUser","dispatchReport","payload","toISOString","context","captureContext","metadata","getBrowserMetadata","navigator","sendBeacon","blob","Blob","JSON","stringify","fallbackFetch","fetch","method","headers","keepalive","error","activeElement","outerHTML","pageTitle","title","scrollPosition","scrollX","scrollY","userAgent","screenSize","width","screen","height","viewportSize","innerWidth","innerHeight","language","platform"],"mappings":"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"}