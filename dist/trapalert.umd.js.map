{"version":3,"file":"trapalert.umd.js","sources":["../src/core/StruggleScore.js","../src/ui/NotificationSystem.js","../src/utils/dom.js","../src/core/BehaviorEngine.js","../src/core/TrapAlert.js","../src/utils/dom-snapshot.js","../src/index.js"],"sourcesContent":["/**\n * StruggleScore - Manages the frustration meter (0-100)\n */\nexport class StruggleScore {\n    constructor(decayRate = 2) {\n        this.score = 0;\n        this.lastDecayTime = Date.now();\n        this.decayRate = decayRate; // points per second\n    }\n\n    setDecayRate(rate) {\n        this.decayRate = rate;\n    }\n\n    add(points) {\n        this.score = this.score + points;\n        return this.score;\n    }\n\n    subtract(points) {\n        this.score = Math.max(0, this.score - points);\n        return this.score;\n    }\n\n    decay() {\n        const now = Date.now();\n        const elapsed = (now - this.lastDecayTime) / 1000; // seconds\n\n        if (elapsed >= 1) {\n            const decayAmount = elapsed * this.decayRate;\n            this.subtract(decayAmount);\n            this.lastDecayTime = now;\n        }\n    }\n\n    get() {\n        return this.score;\n    }\n\n    reset() {\n        this.score = 0;\n        this.lastDecayTime = Date.now();\n    }\n}\n","export class NotificationSystem {\n  constructor(shadowRoot, onReport, onDismiss) {\n    this.shadowRoot = shadowRoot;\n    this.onReport = onReport;\n    this.onDismiss = onDismiss;\n    this.ariaLiveRegion = null;\n    this.initialize();\n  }\n\n  initialize() {\n    this.createAriaLiveRegion();\n    this.createSidebar();\n  }\n\n  createAriaLiveRegion() {\n    this.ariaLiveRegion = document.createElement('div');\n    this.ariaLiveRegion.setAttribute('role', 'status');\n    this.ariaLiveRegion.setAttribute('aria-live', 'assertive');\n    this.ariaLiveRegion.setAttribute('aria-atomic', 'true');\n    this.ariaLiveRegion.style.cssText = `\n      position: absolute;\n      left: -10000px;\n      width: 1px;\n      height: 1px;\n      overflow: hidden;\n    `;\n    this.shadowRoot.appendChild(this.ariaLiveRegion);\n  }\n\n  createSidebar() {\n    const style = document.createElement('style');\n    style.textContent = `\n      :host {\n        --ta-blue: #667eea;\n        --ta-purple: #764ba2;\n        --ta-sidebar-width: 350px;\n      }\n\n      .trapalert-sidebar {\n        position: fixed;\n        top: 0;\n        right: calc(var(--ta-sidebar-width) * -1);\n        width: var(--ta-sidebar-width);\n        height: 100vh;\n        background: linear-gradient(135deg, #1a1c2c 0%, #4a192c 100%);\n        box-shadow: -4px 0 30px rgba(0, 0, 0, 0.5);\n        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        z-index: 999999;\n        color: white;\n        font-family: 'Outfit', sans-serif;\n        display: flex;\n        flex-direction: column;\n        padding: 40px 30px;\n        box-sizing: border-box;\n        border-left: 1px solid rgba(255, 255, 255, 0.1);\n      }\n\n      .trapalert-sidebar.visible {\n        right: 0;\n      }\n\n      .trapalert-handle {\n        position: fixed;\n        right: 0;\n        top: 50%;\n        transform: translateY(-50%);\n        background: #1a1c2c;\n        color: white;\n        padding: 15px 8px;\n        border-radius: 8px 0 0 8px;\n        cursor: pointer;\n        writing-mode: vertical-rl;\n        text-orientation: mixed;\n        font-size: 12px;\n        font-weight: 600;\n        letter-spacing: 1px;\n        text-transform: uppercase;\n        border: 1px solid rgba(255,255,255,0.2);\n        border-right: none;\n        transition: padding 0.2s;\n        z-index: 999998;\n        box-shadow: -2px 0 10px rgba(0,0,0,0.3);\n      }\n\n      .trapalert-handle:hover {\n        padding-right: 15px;\n        background: #2a2c3c;\n      }\n\n      .trapalert-header {\n        font-size: 24px;\n        font-weight: 700;\n        margin-bottom: 20px;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n      }\n\n      .trapalert-icon {\n        width: 36px;\n        height: 36px;\n        background: rgba(255, 255, 255, 0.1);\n        border-radius: 10px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 22px;\n      }\n\n      .trapalert-message {\n        font-size: 15px;\n        line-height: 1.6;\n        margin-bottom: 30px;\n        color: rgba(255, 255, 255, 0.8);\n      }\n\n      .trapalert-score {\n        background: rgba(0, 0, 0, 0.3);\n        padding: 20px;\n        border-radius: 12px;\n        margin-bottom: 25px;\n        border: 1px solid rgba(255, 255, 255, 0.05);\n      }\n\n      .trapalert-score-label {\n        font-size: 11px;\n        text-transform: uppercase;\n        letter-spacing: 1.5px;\n        opacity: 0.6;\n        margin-bottom: 8px;\n      }\n\n      .trapalert-score-value {\n        font-size: 42px;\n        font-weight: 800;\n        background: linear-gradient(to right, #fff, #aab);\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n      }\n\n      .trapalert-button {\n        background: white;\n        color: #1a1c2c;\n        border: none;\n        padding: 16px 24px;\n        border-radius: 10px;\n        font-size: 15px;\n        font-weight: 700;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        margin-bottom: 12px;\n      }\n\n      .trapalert-button:hover {\n        background: #f0f0f0;\n        transform: translateY(-2px);\n      }\n\n      .trapalert-button-secondary {\n        background: rgba(255, 255, 255, 0.1);\n        color: white;\n        border: 1px solid rgba(255, 255, 255, 0.1);\n      }\n\n      .trapalert-button-secondary:hover {\n        background: rgba(255, 255, 255, 0.15);\n      }\n\n      .trapalert-close {\n        position: absolute;\n        top: 20px;\n        right: 20px;\n        background: rgba(255, 255, 255, 0.05);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        color: white;\n        width: 32px;\n        height: 32px;\n        border-radius: 50%;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s;\n      }\n\n      .trapalert-close:hover {\n        background: rgba(255, 255, 255, 0.2);\n        transform: rotate(90deg);\n      }\n\n      .trapalert-timer {\n        font-family: monospace;\n        font-size: 28px;\n        color: #ff4d4d;\n        font-weight: 800;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        margin: 20px 0;\n      }\n\n      .trapalert-timer::before {\n        content: '';\n        width: 14px;\n        height: 14px;\n        background: #ff4d4d;\n        border-radius: 50%;\n        animation: ta-pulse 1s infinite;\n      }\n\n      @keyframes ta-pulse {\n        0% { opacity: 1; transform: scale(1); }\n        50% { opacity: 0.4; transform: scale(1.2); }\n        100% { opacity: 1; transform: scale(1); }\n      }\n\n      .trapalert-captions {\n        margin-top: 20px;\n        padding: 15px;\n        background: rgba(0, 0, 0, 0.4);\n        border-radius: 8px;\n        font-size: 14px;\n        line-height: 1.4;\n        color: #fff;\n        max-height: 120px;\n        overflow-y: auto;\n        width: 100%;\n        border-left: 3px solid var(--ta-blue);\n        display: none;\n      }\n\n      .trapalert-captions.active {\n        display: block;\n      }\n\n      .caption-text {\n        opacity: 0.9;\n      }\n\n      .caption-text:empty::before {\n        content: 'Listening for voice...';\n        opacity: 0.5;\n        font-style: italic;\n      }\n    `;\n    this.shadowRoot.appendChild(style);\n\n    const handle = document.createElement('button');\n    handle.className = 'trapalert-handle';\n    handle.id = 'ta-handle';\n    handle.setAttribute('aria-label', 'Open TrapAlert Reporting Tool');\n    handle.textContent = 'Report Barrier';\n    this.shadowRoot.appendChild(handle);\n\n    const sidebar = document.createElement('aside');\n    sidebar.className = 'trapalert-sidebar';\n    sidebar.setAttribute('role', 'complementary');\n    sidebar.setAttribute('aria-label', 'TrapAlert Accessibility Tool');\n\n    sidebar.innerHTML = `\n      <button class=\"trapalert-close\" id=\"ta-close\" aria-label=\"Close TrapAlert\">√ó</button>\n      <div class=\"trapalert-header\">\n        <div class=\"trapalert-icon\">üõ°Ô∏è</div>\n        <span>TrapAlert</span>\n      </div>\n\n      <!-- Idle UI -->\n      <div id=\"idle-ui\" style=\"display: flex; flex-direction: column;\">\n        <div class=\"trapalert-message\">\n          We've detected potential navigation barriers. Help us improve the experience for everyone.\n        </div>\n        <div class=\"trapalert-score\">\n          <div class=\"trapalert-score-label\">Frustration Intensity</div>\n          <div class=\"trapalert-score-value\" id=\"score-display\">0</div>\n        </div>\n        <button class=\"trapalert-button\" id=\"start-recording-btn\">\n          üé• Record Feedback (Voice + Screen)\n        </button>\n        <button class=\"trapalert-button trapalert-button-secondary\" id=\"report-btn\">\n          Quick Audit Report\n        </button>\n        <button class=\"trapalert-button trapalert-button-secondary\" id=\"dismiss-btn\">\n          Keep Browsing\n        </button>\n      </div>\n\n      <!-- Recording UI -->\n      <div id=\"recording-ui\" style=\"display: none; flex-direction: column; align-items: center;\">\n        <div class=\"trapalert-timer\" id=\"recording-timer\">00:00</div>\n        <div class=\"trapalert-message\" style=\"text-align: center; margin-top: 10px;\">\n           Recording in progress...<br>Explain the issue while you navigate.\n        </div>\n        <div class=\"trapalert-captions\" id=\"captions-container\">\n          <div class=\"caption-text\" id=\"caption-body\"></div>\n        </div>\n        <button class=\"trapalert-button\" id=\"stop-recording-btn\" style=\"background: #ff4d4d; color: white; width: 100%; margin-top: 20px;\">\n          ‚èπÔ∏è Stop and Send\n        </button>\n      </div>\n\n      <!-- Uploading UI -->\n      <div id=\"uploading-ui\" style=\"display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%;\">\n        <div class=\"trapalert-icon\" style=\"width: 60px; height: 60px; font-size: 40px; margin-bottom: 20px;\">‚è≥</div>\n        <div class=\"trapalert-header\" style=\"justify-content: center;\">\n            <span>Finalizing...</span>\n        </div>\n        <div class=\"trapalert-message\" style=\"text-align: center;\">\n           Securely packaging your screen recording and DOM snapshot.\n        </div>\n      </div>\n    `;\n    this.shadowRoot.appendChild(sidebar);\n\n    this.bindEvents();\n  }\n\n  bindEvents() {\n    const handle = this.shadowRoot.querySelector('#ta-handle');\n    const closeBtn = this.shadowRoot.querySelector('#ta-close');\n    const reportBtn = this.shadowRoot.querySelector('#report-btn');\n    const dismissBtn = this.shadowRoot.querySelector('#dismiss-btn');\n    const startRecordBtn = this.shadowRoot.querySelector('#start-recording-btn');\n    const stopRecordBtn = this.shadowRoot.querySelector('#stop-recording-btn');\n\n    handle.addEventListener('click', () => this.show());\n    closeBtn.addEventListener('click', () => this.hide());\n    dismissBtn.addEventListener('click', () => {\n      this.hide();\n      this.onDismiss();\n    });\n    reportBtn.addEventListener('click', () => {\n      this.onReport();\n      this.updateMessage('Thank you. Our team will audit this page immediately.');\n    });\n\n    startRecordBtn.addEventListener('click', () => {\n      if (this.onStartRecording) this.onStartRecording();\n    });\n\n    stopRecordBtn.addEventListener('click', () => {\n      if (this.onStopRecording) this.onStopRecording();\n    });\n  }\n\n  setRecordingState(state) {\n    const idleUI = this.shadowRoot.querySelector('#idle-ui');\n    const recordingUI = this.shadowRoot.querySelector('#recording-ui');\n    const uploadingUI = this.shadowRoot.querySelector('#uploading-ui');\n\n    if (idleUI) idleUI.style.display = state === 'idle' ? 'flex' : 'none';\n    if (recordingUI) recordingUI.style.display = state === 'recording' ? 'flex' : 'none';\n    if (uploadingUI) uploadingUI.style.display = state === 'uploading' ? 'flex' : 'none';\n\n    if (state === 'recording') {\n      this.startTimer();\n    } else {\n      this.stopTimer();\n      if (state === 'idle') {\n        const container = this.shadowRoot.querySelector('#captions-container');\n        const body = this.shadowRoot.querySelector('#caption-body');\n        if (container) container.classList.remove('active');\n        if (body) body.textContent = '';\n      }\n    }\n  }\n\n  startTimer() {\n    let seconds = 0;\n    const timerEl = this.shadowRoot.querySelector('#recording-timer');\n    if (this.timerInterval) clearInterval(this.timerInterval);\n\n    this.timerInterval = setInterval(() => {\n      seconds++;\n      const mins = Math.floor(seconds / 60).toString().padStart(2, '0');\n      const secs = (seconds % 60).toString().padStart(2, '0');\n      if (timerEl) timerEl.textContent = `${mins}:${secs}`;\n    }, 1000);\n  }\n\n  stopTimer() {\n    if (this.timerInterval) {\n      clearInterval(this.timerInterval);\n      this.timerInterval = null;\n    }\n  }\n\n  show(score) {\n    const sidebar = this.shadowRoot.querySelector('.trapalert-sidebar');\n    const handle = this.shadowRoot.querySelector('#ta-handle');\n\n    if (sidebar) {\n      this.setRecordingState('idle'); // Always start with idle\n      if (score !== undefined) this.updateScore(score);\n      sidebar.classList.add('visible');\n      if (handle) handle.style.display = 'none';\n\n      document.body.classList.add('trapalert-open');\n\n      // Programmatic focus for accessibility\n      setTimeout(() => {\n        const closeBtn = this.shadowRoot.querySelector('#ta-close');\n        if (closeBtn) closeBtn.focus();\n      }, 300);\n\n      this.playNotificationSound();\n      this.announce('TrapAlert: Accessibility barrier detected. Sidebar opened.');\n    }\n  }\n\n  hide() {\n    const sidebar = this.shadowRoot.querySelector('.trapalert-sidebar');\n    const handle = this.shadowRoot.querySelector('#ta-handle');\n\n    if (sidebar) {\n      this.stopTimer();\n      sidebar.classList.remove('visible');\n      if (handle) handle.style.display = 'block';\n      document.body.classList.remove('trapalert-open');\n    }\n  }\n\n  updateScore(score) {\n    const scoreDisplay = this.shadowRoot.querySelector('#score-display');\n    if (scoreDisplay) {\n      scoreDisplay.textContent = Math.round(score);\n    }\n  }\n\n  announce(message) {\n    if (this.ariaLiveRegion) {\n      this.ariaLiveRegion.textContent = message;\n    }\n  }\n\n  updateMessage(message) {\n    this.announce(message);\n    const messageEl = this.shadowRoot.querySelector('.trapalert-message');\n    if (messageEl) {\n      messageEl.textContent = message;\n    }\n  }\n\n  updateCaptions(text) {\n    const container = this.shadowRoot.querySelector('#captions-container');\n    const body = this.shadowRoot.querySelector('#caption-body');\n    if (container && body) {\n      container.classList.add('active');\n      body.textContent = text;\n      container.scrollTop = container.scrollHeight;\n    }\n  }\n\n  playNotificationSound() {\n    // Base64 encoded short beep sound (data URI)\n    const audioData = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6foKGio6SlpqeoqaqrrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfY2drb3N3e3+Dh4uPk5ebn6Onq6+zt7u/w8fLz9PX29/j5+vv8/f7/AAECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w==';\n\n    try {\n      const audio = new Audio(audioData);\n      audio.volume = 0.3;\n      audio.play().catch(err => {\n        console.warn('[TrapAlert] Could not play notification sound:', err);\n      });\n    } catch (err) {\n      console.warn('[TrapAlert] Audio not supported:', err);\n    }\n  }\n}\n","/**\n * Get CSS selector for element\n * @param {HTMLElement} element \n * @returns {string} Unique-ish selector\n */\nexport function getElementSelector(element) {\n    if (!element || element === document) return 'document';\n    if (element === window) return 'window';\n\n    if (element.id) {\n        return `#${element.id}`;\n    }\n\n    if (element.className && typeof element.className === 'string') {\n        const classes = element.className.trim().split(/\\s+/).join('.');\n        if (classes) {\n            return `${element.tagName.toLowerCase()}.${classes}`;\n        }\n    }\n\n    return element.tagName.toLowerCase();\n}\n\n/**\n * Check if element is interactive\n * @param {HTMLElement} element \n * @returns {boolean}\n */\nexport function isInteractiveElement(element) {\n    const tagName = element.tagName.toLowerCase();\n    const interactiveTags = ['a', 'button', 'input', 'select', 'textarea'];\n\n    if (interactiveTags.includes(tagName)) return true;\n    if (element.hasAttribute('onclick')) return true;\n    if (element.getAttribute('role') === 'button') return true;\n    if (element.hasAttribute('href')) return true;\n    if (element.hasAttribute('tabindex') && element.getAttribute('tabindex') !== '-1') return true;\n\n    return false;\n}\n\n/**\n * Check if element has pointer cursor\n * @param {HTMLElement} element \n * @returns {boolean}\n */\nexport function hasPointerCursor(element) {\n    try {\n        const style = window.getComputedStyle(element);\n        return style.cursor === 'pointer';\n    } catch (e) {\n        return false;\n    }\n}\n\n/**\n * Get simple XPath for element\n * @param {HTMLElement} element \n * @returns {string}\n */\nexport function getElementXPath(element) {\n    if (element.id !== '') return `//*[@id=\"${element.id}\"]`;\n    if (element === document.body) return '/html/body';\n\n    let ix = 0;\n    const siblings = element.parentNode ? element.parentNode.childNodes : [];\n\n    for (let i = 0; i < siblings.length; i++) {\n        const sibling = siblings[i];\n        if (sibling === element) {\n            return getElementXPath(element.parentNode) + '/' + element.tagName.toLowerCase() + '[' + (ix + 1) + ']';\n        }\n        if (sibling.nodeType === 1 && sibling.tagName === element.tagName) {\n            ix++;\n        }\n    }\n    return '';\n}\n","import { getElementSelector, hasPointerCursor, getElementXPath } from '../utils/dom.js';\n\n/**\n * BehaviorEngine - Advanced logic for detecting struggle vs power usage\n */\nexport class BehaviorEngine {\n    constructor(struggleScore) {\n        this.struggleScore = struggleScore;\n\n        // Efficiency Ratio State\n        this.focusBuffer = []; // stores { id, xpath }\n        this.maxFocusBuffer = 20;\n\n        // U-Turn State\n        this.navigationHistory = []; // stores selector strings\n        this.maxNavHistory = 10;\n\n        // Rage Click State\n        this.clickHistory = new Map(); // selector -> [timestamps]\n\n        // Dead-End Tab State\n        this.tabCount = 0;\n        this.lastProductiveAction = Date.now();\n\n        // Input Abandonment State\n        this.currentInputObj = null; // { element, startLen, maxLen, typed }\n\n        // Advanced Heuristics State\n        this.momentumEndsAt = 0; // Timestamp when success momentum buffer ends\n        this.sensitivityMultiplier = 1; // Default sensitivity\n        this.sensitivityEndsAt = 0; // Timestamp when high sensitivity ends\n        this.interactedElements = new Set(); // Selectors of elements user has productively interacted with\n        this.focusClusterBuffer = []; // stores { x, y } for cluster analysis\n    }\n\n    /**\n     * Helper to add score with momentum and sensitivity applied\n     */\n    addScore(points, reason) {\n        const now = Date.now();\n        let finalPoints = points;\n\n        // Mark trigger for velocity gate\n        if (this.onTrigger) this.onTrigger();\n\n        // Apply Sensitivity Multiplier\n        if (now < this.sensitivityEndsAt) {\n            finalPoints *= this.sensitivityMultiplier;\n        }\n\n        // Apply Success Momentum (Buffer)\n        // Bypass buffer for Rage Clicks or serious context sensitivity\n        const isFrustrationMarker = points >= 60 || reason === 'Rage Click';\n\n        if (now < this.momentumEndsAt && !isFrustrationMarker) {\n            // Buffer reduces increments by 80%\n            finalPoints *= 0.2;\n        }\n\n        finalPoints = Math.round(finalPoints);\n\n        if (finalPoints > 0) {\n            console.log(`[BehaviorEngine] Adding ${finalPoints} points (${reason}). Base: ${points}, Sens: ${this.sensitivityMultiplier}, Mom: ${now < this.momentumEndsAt}`);\n            this.struggleScore.add(finalPoints);\n        }\n    }\n\n    /**\n     * Register a successful action (typing, clicking, navigating)\n     */\n    registerSuccess() {\n        this.momentumEndsAt = Date.now() + 5000; // 5 second buffer\n        this.resetDeadEndTab();\n        this.uTurnCounter = 0; // Reset grace period on success\n\n        // High decay rate during momentum\n        this.struggleScore.setDecayRate(10);\n\n        // Instant drain\n        this.struggleScore.subtract(10);\n\n        // Revert decay rate after 5 seconds\n        if (this.decayRevertTimeout) clearTimeout(this.decayRevertTimeout);\n        this.decayRevertTimeout = setTimeout(() => {\n            this.struggleScore.setDecayRate(2);\n        }, 5000);\n    }\n\n    /**\n     * Register a high-risk context shift (error message, submit click)\n     */\n    registerContextShift(isSubmit = false) {\n        // Clear momentum immediately\n        this.momentumEndsAt = 0;\n        this.uTurnCounter = 0; // Reset for fresh state\n\n        // Increase sensitivity\n        this.sensitivityMultiplier = 2;\n        this.sensitivityEndsAt = Date.now() + 30000; // 30 seconds\n\n        console.log(`[BehaviorEngine] Context Shift! Sensitivity doubled. Submit: ${isSubmit}`);\n    }\n\n    /**\n     * Process focusin events for Efficiency Ratio & U-Turn\n     */\n    handleFocus(element) {\n        const selector = getElementSelector(element);\n        const xpath = getElementXPath(element);\n        const id = element.id || null;\n        const now = Date.now();\n\n        // 0. History Pruning: Remove events older than 60 seconds\n        this.pruneHistory(now);\n\n        // Check if previously interacted (Interaction History)\n        if (this.interactedElements.has(selector)) {\n            // Do not penalize re-focusing inputs they already worked on\n            return;\n        }\n\n        // 1. Efficiency Ratio Buffer update\n        this.focusBuffer.push({ id, xpath, timestamp: now });\n        if (this.focusBuffer.length > this.maxFocusBuffer) {\n            this.focusBuffer.shift();\n        }\n\n        // 2. Cluster-Loop Detection\n        const rect = element.getBoundingClientRect();\n        this.focusClusterBuffer.push({\n            x: rect.left,\n            y: rect.top,\n            selector: selector,\n            timestamp: now\n        });\n        if (this.focusClusterBuffer.length > 5) this.focusClusterBuffer.shift();\n\n        this.detectClusterLoop();\n\n        this.evaluateEfficiency();\n\n        // 3. U-Turn Detection\n        this.navigationHistory.push(selector);\n        if (this.navigationHistory.length > this.maxNavHistory) {\n            this.navigationHistory.shift();\n        }\n        this.detectUTurn();\n    }\n\n    pruneHistory(now) {\n        const threshold = 60000; // 60 seconds\n        this.focusBuffer = this.focusBuffer.filter(item => now - item.timestamp < threshold);\n        this.focusClusterBuffer = this.focusClusterBuffer.filter(item => now - item.timestamp < threshold);\n    }\n\n    detectClusterLoop() {\n        if (this.focusClusterBuffer.length < 5) return;\n\n        // Visual Distance Check: Are all 5 points within a 300px box?\n        const xs = this.focusClusterBuffer.map(p => p.x);\n        const ys = this.focusClusterBuffer.map(p => p.y);\n\n        const minX = Math.min(...xs);\n        const maxX = Math.max(...xs);\n        const minY = Math.min(...ys);\n        const maxY = Math.max(...ys);\n\n        const width = maxX - minX;\n        const height = maxY - minY;\n\n        if (width < 300 && height < 300) {\n            // Check for repetition within the cluster (avoid flagging toolbars)\n            const selectors = this.focusClusterBuffer.map(p => p.selector);\n            const uniqueInCluster = new Set(selectors).size;\n\n            // If we have 5 events but only 1 or 2 unique elements, we are vibrating in place\n            // (U-Turn logic handles 3-element patterns like A-B-C-B-A better)\n            if (uniqueInCluster < 3) {\n                console.log('[BehaviorEngine] Localized Trap (Cluster) detected');\n                this.addScore(10, 'Localized Trap');\n            }\n        }\n    }\n\n    /**\n     * \"Efficiency Ratio\" Logic\n     */\n    evaluateEfficiency() {\n        const totalEvents = this.focusBuffer.length;\n        if (totalEvents < 8) return; // Wait for a more robust sample (was 5)\n\n        // Definition of Unique Focus: The count of unique id or xpath attributes\n        const uniqueKeys = new Set(this.focusBuffer.map(item => item.id || item.xpath));\n        const uniqueCount = uniqueKeys.size;\n\n        const efficiency = uniqueCount / totalEvents;\n\n        // Behavioral Trigger\n        if (efficiency < 0.25) { // Slightly more strict (was 0.3)\n            // User is hitting the same 4-5 elements repeatedly\n            this.addScore(5, 'Low Efficiency');\n        } else if (efficiency > 0.8) {\n            // Power User Protection\n            // Decrease Struggle Score by -20 points\n            // Note: Limit frequency of this reward or check if we just crossed the threshold?\n            // \"Decrease Struggle Score by -20 points (Power User Protection)\" implies a one-time bonus or periodic?\n            // \"per event\" isn't specified for the bonus, but typically power user behavior is continuous.\n            // If we subtract 20 on EVERY focus event, score will stay 0. That's probably intended.\n            // If exploring effectively, we shouldn't count \"Dead-End Tabs\"\n            this.resetDeadEndTab();\n\n            if (this.struggleScore.get() > 0) {\n                this.struggleScore.subtract(20);\n            }\n        }\n    }\n\n    /**\n     * \"The U-Turn\" Logic\n     * A -> B -> C -> B -> A\n     */\n    detectUTurn() {\n        if (this.navigationHistory.length < 5) return;\n\n        const h = this.navigationHistory;\n        const len = h.length;\n\n        // A -> B -> C -> B -> A\n        // A=idx-4, B=idx-3, C=idx-2, B=idx-1, A=idx\n        const A1 = h[len - 5];\n        const B1 = h[len - 4];\n        const C = h[len - 3];\n        const B2 = h[len - 2];\n        const A2 = h[len - 1];\n\n        if (A1 === A2 && B1 === B2 && A1 !== B1 && B1 !== C) {\n            // First U-Turn is often a valid correction.\n            // Only penalize if they've done it recently or are in a sensitive state.\n            this.uTurnCounter = (this.uTurnCounter || 0) + 1;\n\n            if (this.uTurnCounter > 1) {\n                console.log('[BehaviorEngine] Repeated U-Turn detected');\n                this.addScore(20, 'Repeated U-Turn'); // Reduced from 30\n            } else {\n                console.log('[BehaviorEngine] Intentional U-Turn (Normalization)');\n                // If it's a one-off, we grant a \"grace\" score\n                this.addScore(5, 'Minor Backtrack');\n            }\n\n            // Clear history and reset counter if they start moving again\n            this.navigationHistory = [];\n        }\n    }\n\n    /**\n     * \"Rage Clicking\" Logic\n     */\n    handleClick(element) {\n        const selector = getElementSelector(element);\n        const now = Date.now();\n\n        const hasPointer = hasPointerCursor(element);\n        const likelyInteractive = ['a', 'button', 'input', 'select', 'textarea'].includes(element.tagName.toLowerCase())\n            || element.hasAttribute('onclick')\n            || element.getAttribute('role') === 'button';\n\n        // 1. Success Verification: Don't give momentum until we see a result (mutation)\n        if (likelyInteractive || hasPointer) {\n            this.pendingSuccess = {\n                timestamp: now,\n                type: 'click',\n                selector: selector\n            };\n            // We'll wait for a mutation to confirm\n            setTimeout(() => {\n                if (this.pendingSuccess && this.pendingSuccess.timestamp === now) {\n                    this.pendingSuccess = null; // Expired\n                }\n            }, 1000);\n        }\n\n        // Track interaction for history\n        if (['input', 'textarea', 'select'].includes(element.tagName.toLowerCase())) {\n            this.interactedElements.add(selector);\n        }\n\n        // Check for Submit button click\n        if (element.getAttribute('type') === 'submit' || element.getAttribute('role') === 'button') {\n            this.registerContextShift(true);\n        }\n\n        if (!this.clickHistory.has(selector)) {\n            this.clickHistory.set(selector, []);\n        }\n\n        const clicks = this.clickHistory.get(selector);\n        clicks.push(now);\n\n        const recentClicks = clicks.filter(t => now - t < 2000);\n        this.clickHistory.set(selector, recentClicks);\n\n        if (recentClicks.length > 5) {\n            if (!hasPointer && !likelyInteractive) {\n                // Rage clicking on static text\n                this.addScore(60, 'Rage Click (Static)');\n                this.clickHistory.delete(selector);\n            } else {\n                // Rage clicking on a BUTTON (Possible Dead-End/Broken Button)\n                // This answers: \"what if the button is not working?\"\n                console.log('[BehaviorEngine] Potential Broken Button / Dead-End Click sequence');\n                this.addScore(40, 'Button Mashing'); // Serious frustration but potentially valid (just slow)\n                this.clickHistory.delete(selector);\n            }\n        }\n    }\n\n    /**\n     * Called by TrapAlert when a DOM mutation is detected\n     */\n    registerMutation() {\n        if (this.pendingSuccess) {\n            console.log(`[BehaviorEngine] Click on ${this.pendingSuccess.selector} verified by DOM mutation. Registering Success.`);\n            this.registerSuccess();\n            this.pendingSuccess = null;\n        }\n    }\n\n    /**\n     * \"The Dead-End Tab\"\n     * >15 tabs without a single change (or while stuck).\n     * If handled in handleFocus via efficiency resets, this just catches\n     * pure rapid tabbing without focus change (rare) OR low-efficiency tabbing.\n     */\n    handleTab() {\n        // We defer penalty. If the user tabs 15 times but Efficiency is High, evaluateEfficiency resets this.\n        // If Efficiency is Low (Looping), this accumulates and penalizes ON TOP of Efficiency penalties.\n        this.tabCount++;\n        if (this.tabCount > 15) {\n            this.addScore(40, 'Dead-End Tab');\n            this.tabCount = 0;\n        }\n    }\n\n    resetDeadEndTab() {\n        this.tabCount = 0;\n    }\n\n    /**\n     * \"Input Abandonment\"\n     * User clicks an input, types <3 chars, deletes them, and tabs away.\n     */\n    handleInputFocus(element) {\n        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {\n            this.currentInputObj = {\n                element: element,\n                startValue: element.value,\n                maxLenReached: element.value.length,\n                typed: false\n            };\n        }\n    }\n\n    handleInputType(element) {\n        this.registerSuccess();\n\n        if (this.currentInputObj && this.currentInputObj.element === element) {\n            this.currentInputObj.typed = true;\n            this.interactedElements.add(getElementSelector(element)); // Mark as Productive Interaction\n\n            if (element.value.length > this.currentInputObj.maxLenReached) {\n                this.currentInputObj.maxLenReached = element.value.length;\n            }\n        }\n    }\n\n    handleInputBlur(element) {\n        if (this.currentInputObj && this.currentInputObj.element === element) {\n            const finalLen = element.value.length;\n            const startLen = this.currentInputObj.startValue.length;\n            const charsAdded = this.currentInputObj.maxLenReached - startLen; // rough approximation of \"typed\"\n\n            // \"types <3 chars, deletes them (so back to start or empty), and tabs away (blur)\"\n            // Simplification: Check if they typed something small and then cleared/reverted it.\n            const wasEdited = this.currentInputObj.typed;\n            const reverted = finalLen <= startLen; // Or strictly empty? \"deletes them\" triggers usually mean empty or original state\n            const smallEffort = charsAdded > 0 && charsAdded < 3;\n\n            if (wasEdited && smallEffort && reverted) {\n                this.addScore(20, 'Input Abandonment');\n            }\n\n            this.currentInputObj = null;\n        }\n    }\n}\n","import { StruggleScore } from './StruggleScore.js';\nimport { NotificationSystem } from '../ui/NotificationSystem.js';\nimport { getElementSelector, isInteractiveElement } from '../utils/dom.js';\nimport { BehaviorEngine } from './BehaviorEngine.js';\nimport { captureDOMSnapshot } from '../utils/dom-snapshot.js';\n\n/**\n * Main TrapAlert Class\n */\nexport class TrapAlert {\n    constructor(config) {\n        if (!config || !config.tenantId || !config.collectorEndpoint) {\n            throw new Error('TrapAlert requires tenantId and collectorEndpoint');\n        }\n\n        this.tenantId = config.tenantId;\n        this.collectorEndpoint = config.collectorEndpoint;\n        this.struggleScore = new StruggleScore();\n        this.behavioralTrace = [];\n        this.maxTraceLength = 20;\n\n        this.behaviorEngine = new BehaviorEngine(this.struggleScore);\n        this.behaviorEngine.onTrigger = () => {\n            this.lastTriggerTime = Date.now();\n        };\n\n        // Recording state\n        this.mediaRecorder = null;\n        this.recordedChunks = [];\n        this.domSnapshot = null;\n        this.recognition = null;\n        this.finalTranscript = '';\n\n        // Watchers state\n        this.focusHistory = [];\n        this.escPressHistory = [];\n        this.lastProductiveTime = Date.now();\n        this.startTime = Date.now();\n        this.lastTriggerTime = Date.now();\n        this.activationThreshold = 100;\n        this.triggerLevel = 0; // 0: not triggered, 1: first trigger, 2: escalated trigger\n\n        // UI state\n        this.notificationShown = false;\n        this.ui = null;\n\n        this.init();\n    }\n\n    init() {\n        this.setupUI();\n        this.attachListeners();\n        this.startDecayTimer();\n        this.startVelocityGateMonitor();\n        console.log(`[TrapAlert] Initialized for tenant: ${this.tenantId}`);\n    }\n\n    startVelocityGateMonitor() {\n        setInterval(() => {\n            const now = Date.now();\n            const timeSinceStart = now - this.startTime;\n            const timeSinceLastTrigger = now - this.lastTriggerTime;\n\n            if (timeSinceStart > 600000 && timeSinceLastTrigger > 600000) {\n                // > 10 minutes (600,000 ms) without a trigger\n                if (this.activationThreshold === 100) { // Only increase once\n                    this.activationThreshold = 120; // Increase by 20%\n                    console.log('[TrapAlert] Velocity Gate: Increasing threshold to 120 for happy user.');\n                }\n            }\n        }, 60000); // Check every minute\n    }\n\n    setupUI() {\n        // 1. Inject Global Layout Shift Styles\n        const globalStyle = document.createElement('style');\n        globalStyle.textContent = `\n            body.trapalert-open {\n                margin-right: 350px;\n                transition: margin 0.3s ease;\n                overflow-x: hidden;\n            }\n            .ta-skip-link {\n                position: absolute;\n                top: -100px;\n                left: 0;\n                background: #1a1c2c;\n                color: white;\n                padding: 15px 25px;\n                z-index: 1000000;\n                text-decoration: none;\n                font-weight: bold;\n                border-bottom: 2px solid #fff;\n                transition: top 0.2s;\n            }\n            .ta-skip-link:focus {\n                top: 0;\n            }\n        `;\n        document.head.appendChild(globalStyle);\n\n        // 2. Inject Skip Link (Discovery for Screen Readers)\n        const skipLink = document.createElement('a');\n        skipLink.href = '#';\n        skipLink.className = 'ta-skip-link';\n        skipLink.textContent = 'Skip to Report Accessibility Issue with TrapAlert';\n        skipLink.addEventListener('click', (e) => {\n            e.preventDefault();\n            this.ui.show(this.struggleScore.get());\n        });\n        document.body.prepend(skipLink);\n\n        // 3. Setup Shadow DOM Container\n        const container = document.createElement('div');\n        container.id = 'trapalert-container';\n        container.setAttribute('aria-hidden', 'false');\n        document.body.appendChild(container);\n\n        const shadowRoot = container.attachShadow({ mode: 'open' });\n        this.ui = new NotificationSystem(\n            shadowRoot,\n            () => this.handleReport(),\n            () => this.handleDismiss()\n        );\n\n        // Bind recording handlers\n        this.ui.onStartRecording = this.handleStartRecording.bind(this);\n        this.ui.onStopRecording = this.handleStopRecording.bind(this);\n    }\n\n    async handleStartRecording() {\n        try {\n            // 1. Capture DOM Snapshot immediately\n            this.domSnapshot = captureDOMSnapshot();\n            console.log('[TrapAlert] DOM Snapshot captured.');\n\n            // 2. Get Screen and Audio streams\n            const screenStream = await navigator.mediaDevices.getDisplayMedia({\n                video: true\n            });\n\n            let combinedStream = screenStream;\n\n            try {\n                // Request audio separately to merge\n                const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });\n                const tracks = [...screenStream.getVideoTracks(), ...audioStream.getAudioTracks()];\n                combinedStream = new MediaStream(tracks);\n            } catch (err) {\n                console.warn('[TrapAlert] Microphone access denied, recording screen without audio.');\n            }\n\n            // 3. Initialize MediaRecorder\n            this.recordedChunks = [];\n\n            // Check supported types\n            const mimeType = 'video/webm;codecs=vp8,opus';\n            this.mediaRecorder = new MediaRecorder(combinedStream, { mimeType });\n\n            this.mediaRecorder.ondataavailable = (event) => {\n                if (event.data.size > 0) {\n                    this.recordedChunks.push(event.data);\n                }\n            };\n\n            this.mediaRecorder.onstop = () => {\n                this.finalizeRecording();\n                // Stop all tracks to release hardware\n                combinedStream.getTracks().forEach(track => track.stop());\n            };\n\n            this.mediaRecorder.start();\n            this.ui.setRecordingState('recording');\n            console.log('[TrapAlert] Recording started.');\n\n            // 4. Start Speech Recognition for Live Captions\n            this.setupSpeechRecognition();\n\n            // Sync: If the user stops screen sharing via browser native UI\n            screenStream.getVideoTracks()[0].onended = () => {\n                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {\n                    this.mediaRecorder.stop();\n                }\n            };\n\n        } catch (err) {\n            console.error('[TrapAlert] Failed to start recording:', err);\n            alert('Feedback Recording Error: Please ensure you grant Screen and Microphone permissions.');\n        }\n    }\n\n    handleStopRecording() {\n        if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {\n            this.mediaRecorder.stop();\n            this.ui.setRecordingState('uploading');\n        }\n        if (this.recognition) {\n            this.recognition.stop();\n        }\n    }\n\n    setupSpeechRecognition() {\n        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;\n        if (!SpeechRecognition) {\n            console.warn('[TrapAlert] Speech Recognition not supported in this browser.');\n            return;\n        }\n\n        this.recognition = new SpeechRecognition();\n        this.recognition.continuous = true;\n        this.recognition.interimResults = true;\n        this.recognition.lang = 'en-US';\n\n        this.recognition.onresult = (event) => {\n            let interimTranscript = '';\n\n            for (let i = event.resultIndex; i < event.results.length; i++) {\n                const transcript = event.results[i][0].transcript;\n                if (event.results[i].isFinal) {\n                    this.finalTranscript += transcript + ' ';\n                } else {\n                    interimTranscript += transcript;\n                }\n            }\n\n            this.ui.updateCaptions(this.finalTranscript + interimTranscript);\n        };\n\n        this.recognition.onerror = (event) => {\n            console.error('[TrapAlert] Speech Recognition Error:', event.error);\n        };\n\n        this.recognition.onend = () => {\n            console.log('[TrapAlert] Speech Recognition ended.');\n            // Restart if we are still recording (handle timeouts)\n            if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {\n                try {\n                    this.recognition.start();\n                } catch (e) {\n                    console.log('Could not restart recognition:', e);\n                }\n            }\n        };\n\n        try {\n            this.finalTranscript = ''; // Reset for new recording\n            this.recognition.start();\n        } catch (err) {\n            console.error('[TrapAlert] Failed to start Speech Recognition:', err);\n        }\n    }\n\n    async finalizeRecording() {\n        const videoBlob = new Blob(this.recordedChunks, { type: 'video/webm' });\n\n        const formData = new FormData();\n        formData.append('video', videoBlob, 'feedback-recording.webm');\n        formData.append('dom', this.domSnapshot);\n        formData.append('metadata', JSON.stringify(this.getBrowserMetadata()));\n        formData.append('struggleScore', this.struggleScore.get());\n        formData.append('transcript', this.finalTranscript.trim()); // Add transcript\n        formData.append('tenantId', this.tenantId);\n\n        console.log('[TrapAlert] Dispatching multi-modal feedback...');\n\n        try {\n            const response = await fetch(`${this.collectorEndpoint}/feedback`, {\n                method: 'POST',\n                body: formData\n            });\n\n            if (response.ok) {\n                console.log('[TrapAlert] Feedback uploaded successfully.');\n                this.ui.updateMessage('Feedback sent! Our engineers will audit this snapshot immediately.');\n            } else {\n                throw new Error('Upload failed');\n            }\n        } catch (err) {\n            console.error('[TrapAlert] Feedback upload failed:', err);\n            this.ui.updateMessage('Something went wrong during upload. Please try again.');\n        } finally {\n            setTimeout(() => {\n                this.ui.setRecordingState('idle');\n                this.struggleScore.reset();\n                this.domSnapshot = null;\n            }, 3000);\n        }\n    }\n\n    attachListeners() {\n        // Focus tracking\n        window.addEventListener('focusin', this.handleFocusIn.bind(this), true);\n        window.addEventListener('focusout', this.handleFocusOut.bind(this), true);\n\n        // Keyboard events\n        window.addEventListener('keydown', this.handleKeyDown.bind(this), true);\n\n        // Click events\n        window.addEventListener('click', this.handleClick.bind(this), true);\n\n        // Input events (productive behavior)\n        window.addEventListener('input', this.handleInput.bind(this), true);\n\n        // Alt+T shortcut for manual report\n        window.addEventListener('keydown', this.handleShortcut.bind(this), true);\n\n        // DOM Mutations (Error/Context Shift Detection)\n        this.observer = new MutationObserver(this.handleMutations.bind(this));\n        this.observer.observe(document.body, {\n            childList: true,\n            subtree: true,\n            attributes: true,\n            attributeFilter: ['role', 'aria-live', 'class', 'style']\n        });\n\n        // Tab Visibility tracking\n        window.addEventListener('visibilitychange', () => {\n            if (document.hidden) {\n                console.log('[TrapAlert] Tab hidden - resetting frustration engine');\n                this.struggleScore.reset();\n                this.triggerLevel = 0;\n                this.behaviorEngine.resetDeadEndTab();\n            }\n        });\n    }\n\n    handleMutations(mutations) {\n        // Notify behavior engine that something happened on the page\n        if (mutations.length > 0) {\n            this.behaviorEngine.registerMutation();\n        }\n\n        for (const mutation of mutations) {\n            if (mutation.type === 'childList') {\n                mutation.addedNodes.forEach(node => {\n                    if (node.nodeType === 1) { // Element node\n                        this.checkErrorNode(node);\n                    }\n                });\n            } else if (mutation.type === 'attributes') {\n                this.checkErrorNode(mutation.target);\n            }\n        }\n    }\n\n    checkErrorNode(node) {\n        if (!node.getAttribute) return;\n\n        const role = node.getAttribute('role');\n        const ariaLive = node.getAttribute('aria-live');\n\n        // Check for error markers\n        const isError = role === 'alert' ||\n            ariaLive === 'assertive' ||\n            (node.className && typeof node.className === 'string' && node.className.toLowerCase().includes('error'));\n\n        if (isError) {\n            console.log('[TrapAlert] Error message detected (DOM Mutation)');\n            this.behaviorEngine.registerContextShift(false);\n        }\n    }\n\n    handleFocusIn(event) {\n        const target = event.target;\n        const selector = getElementSelector(target);\n        const now = Date.now();\n\n        this.addToTrace('focusin', selector);\n\n        // Context tracking\n        this.focusHistory.push({\n            element: target,\n            selector: selector,\n            timestamp: now\n        });\n\n        // Prune focus history older than 60 seconds\n        this.focusHistory = this.focusHistory.filter(h => now - h.timestamp < 60000);\n\n        if (this.focusHistory.length > 20) {\n            this.focusHistory.shift();\n        }\n\n        // Analysis\n        this.behaviorEngine.handleFocus(target);\n        this.behaviorEngine.handleInputFocus(target);\n        this.checkThreshold();\n    }\n\n    handleFocusOut(event) {\n        this.behaviorEngine.handleInputBlur(event.target);\n        this.checkThreshold();\n    }\n\n    handleKeyDown(event) {\n        this.addToTrace('keydown', event.key);\n\n        if (event.key === 'Tab') {\n            this.behaviorEngine.handleTab();\n            this.checkThreshold();\n        }\n\n        if (event.key === 'Escape') {\n            this.handleEscapePress();\n        }\n    }\n\n    handleEscapePress() {\n        const now = Date.now();\n        this.escPressHistory.push(now);\n        this.escPressHistory = this.escPressHistory.filter(t => now - t < 3000);\n\n        if (this.escPressHistory.length >= 3) {\n            console.log('[TrapAlert] Rapid Escape presses detected');\n            this.struggleScore.add(50);\n            this.checkThreshold();\n            this.escPressHistory = [];\n        }\n    }\n\n    handleClick(event) {\n        const target = event.target;\n        const selector = getElementSelector(target);\n\n        this.addToTrace('click', selector);\n        this.markProductiveBehavior();\n\n        this.behaviorEngine.handleClick(target);\n        this.checkThreshold();\n    }\n\n    handleInput(event) {\n        this.addToTrace('input', getElementSelector(event.target));\n        this.markProductiveBehavior();\n        this.behaviorEngine.handleInputType(event.target);\n    }\n\n    markProductiveBehavior() {\n        this.lastProductiveTime = Date.now();\n        // Reset Dead-End Tab count on productive behavior\n        this.behaviorEngine.resetDeadEndTab();\n    }\n\n    handleShortcut(event) {\n        if (event.altKey && event.key === 't') {\n            event.preventDefault();\n            this.ui.show(this.struggleScore.get());\n        }\n    }\n\n    startDecayTimer() {\n        // Every second for smooth bucket behavior\n        setInterval(() => {\n            this.struggleScore.decay();\n            if (this.notificationShown) {\n                this.ui.updateScore(this.struggleScore.get());\n            }\n        }, 1000);\n    }\n\n    addToTrace(type, detail) {\n        this.behavioralTrace.push({\n            type: type,\n            detail: detail,\n            timestamp: Date.now(),\n            url: window.location.href\n        });\n\n        if (this.behavioralTrace.length > this.maxTraceLength) {\n            this.behavioralTrace.shift();\n        }\n    }\n\n    checkThreshold() {\n        const score = this.struggleScore.get();\n        const firstLimit = this.activationThreshold;\n        const secondLimit = firstLimit * 2;\n\n        // Level 1: Initial Trigger\n        if (this.triggerLevel === 0 && score >= firstLimit) {\n            console.log(`[TrapAlert] Level 1 Trigger (Score: ${score}, Threshold: ${firstLimit})`);\n            this.triggerLevel = 1;\n            this.notifyUser();\n        }\n        // Level 2: Escalation (2x Threshold)\n        else if (this.triggerLevel === 1 && score >= secondLimit) {\n            console.log(`[TrapAlert] Level 2 Escalation (Score: ${score}, Threshold: ${secondLimit})`);\n            this.triggerLevel = 2;\n            this.notifyUser();\n        }\n\n        // Reset Level if score drops significantly (e.g., back to near 0)\n        // This allows the cycle to restart if the user successfully recovers\n        if (score < 10 && this.triggerLevel !== 0) {\n            this.triggerLevel = 0;\n        }\n    }\n\n    notifyUser() {\n        if (this.notificationShown) return;\n        this.notificationShown = true;\n        this.ui.show(this.struggleScore.get());\n    }\n\n    handleDismiss() {\n        this.notificationShown = false;\n        // Optimization: We keep triggerLevel as is, so it only pops again at 2x threshold\n    }\n\n    handleReport() {\n        this.dispatchReport();\n        this.notificationShown = false;\n        this.struggleScore.reset();\n        this.triggerLevel = 0; // Full reset on report\n    }\n\n    dispatchReport() {\n        const payload = {\n            tenantId: this.tenantId,\n            timestamp: new Date().toISOString(),\n            url: window.location.href,\n            struggleScore: this.struggleScore.get(),\n            behavioralTrace: this.behavioralTrace,\n            context: this.captureContext(),\n            metadata: this.getBrowserMetadata()\n        };\n\n        console.log('[TrapAlert] Dispatching report:', payload);\n\n        if (navigator.sendBeacon) {\n            const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });\n            const sent = navigator.sendBeacon(this.collectorEndpoint, blob);\n\n            if (!sent) {\n                this.fallbackFetch(payload);\n            }\n        } else {\n            this.fallbackFetch(payload);\n        }\n    }\n\n    fallbackFetch(payload) {\n        fetch(this.collectorEndpoint, {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify(payload),\n            keepalive: true\n        }).catch(err => {\n            console.error('[TrapAlert] Failed to send report:', err);\n        });\n    }\n\n    captureContext() {\n        const activeElement = document.activeElement;\n\n        return {\n            activeElement: {\n                selector: getElementSelector(activeElement),\n                outerHTML: activeElement ? activeElement.outerHTML : null,\n                tagName: activeElement ? activeElement.tagName : null,\n                role: activeElement ? activeElement.getAttribute('role') : null\n            },\n            focusHistory: this.focusHistory.map(h => ({\n                selector: h.selector,\n                timestamp: h.timestamp\n            })),\n            pageTitle: document.title,\n            scrollPosition: {\n                x: window.scrollX,\n                y: window.scrollY\n            }\n        };\n    }\n\n    getBrowserMetadata() {\n        return {\n            userAgent: navigator.userAgent,\n            screenSize: {\n                width: window.screen.width,\n                height: window.screen.height\n            },\n            viewportSize: {\n                width: window.innerWidth,\n                height: window.innerHeight\n            },\n            language: navigator.language,\n            platform: navigator.platform,\n            timestamp: Date.now()\n        };\n    }\n}\n","/**\n * Serializes the current DOM state into a snapshot.\n * Captures document structure, styles, and form values.\n */\nexport function captureDOMSnapshot() {\n    const doc = document.cloneNode(true);\n    const root = doc.documentElement;\n\n    // 1. Convert relative URLs to absolute URLs\n    const base = window.location.href;\n\n    const convertToAbs = (attr) => {\n        root.querySelectorAll(`[${attr}]`).forEach(el => {\n            const val = el.getAttribute(attr);\n            if (val && !val.startsWith('http') && !val.startsWith('data:') && !val.startsWith('//')) {\n                try {\n                    el.setAttribute(attr, new URL(val, base).href);\n                } catch (e) { }\n            }\n        });\n    };\n\n    ['src', 'href'].forEach(convertToAbs);\n\n    // 2. Capture dynamic state that isn't in outerHTML (scroll, inputs)\n    // We iterate the REAL document and apply values to the CLONE\n    const allRealElements = document.querySelectorAll('*');\n    const allCloneElements = root.querySelectorAll('*');\n\n    allRealElements.forEach((realEl, i) => {\n        const cloneEl = allCloneElements[i];\n        if (!cloneEl) return;\n\n        // Capture input values\n        if (realEl.tagName === 'INPUT' || realEl.tagName === 'TEXTAREA' || realEl.tagName === 'SELECT') {\n            cloneEl.value = realEl.value;\n        }\n\n        // Capture canvas as data URL\n        if (realEl.tagName === 'CANVAS') {\n            const img = doc.createElement('img');\n            img.src = realEl.toDataURL();\n            img.style.cssText = realEl.style.cssText;\n            cloneEl.replaceWith(img);\n        }\n\n        // Capture scroll positions as attributes\n        if (realEl.scrollTop > 0) cloneEl.setAttribute('data-ta-scroll-top', realEl.scrollTop);\n        if (realEl.scrollLeft > 0) cloneEl.setAttribute('data-ta-scroll-left', realEl.scrollLeft);\n    });\n\n    // 3. Inject computed styles for reliability\n    // (Optional: can be heavy, but ensures visual fidelity)\n\n    return root.outerHTML;\n}\n","import { TrapAlert } from './core/TrapAlert.js';\n\n// Export for ES modules\nexport { TrapAlert };\n\n// Export for UMD/Browser\nif (typeof window !== 'undefined') {\n    window.TrapAlert = {\n        init: (config) => new TrapAlert(config)\n    };\n}\n"],"names":["StruggleScore","constructor","decayRate","this","score","lastDecayTime","Date","now","setDecayRate","rate","add","points","subtract","Math","max","decay","elapsed","decayAmount","get","reset","NotificationSystem","shadowRoot","onReport","onDismiss","ariaLiveRegion","initialize","createAriaLiveRegion","createSidebar","document","createElement","setAttribute","style","cssText","appendChild","textContent","handle","className","id","sidebar","innerHTML","bindEvents","querySelector","closeBtn","reportBtn","dismissBtn","startRecordBtn","stopRecordBtn","addEventListener","show","hide","updateMessage","onStartRecording","onStopRecording","setRecordingState","state","idleUI","recordingUI","uploadingUI","display","startTimer","stopTimer","container","body","classList","remove","seconds","timerEl","timerInterval","clearInterval","setInterval","mins","floor","toString","padStart","secs","updateScore","setTimeout","focus","playNotificationSound","announce","scoreDisplay","round","message","messageEl","updateCaptions","text","scrollTop","scrollHeight","audio","Audio","volume","play","catch","err","console","warn","getElementSelector","element","window","classes","trim","split","join","tagName","toLowerCase","getElementXPath","ix","siblings","parentNode","childNodes","i","length","sibling","nodeType","BehaviorEngine","struggleScore","focusBuffer","maxFocusBuffer","navigationHistory","maxNavHistory","clickHistory","Map","tabCount","lastProductiveAction","currentInputObj","momentumEndsAt","sensitivityMultiplier","sensitivityEndsAt","interactedElements","Set","focusClusterBuffer","addScore","reason","finalPoints","onTrigger","isFrustrationMarker","log","registerSuccess","resetDeadEndTab","uTurnCounter","decayRevertTimeout","clearTimeout","registerContextShift","isSubmit","handleFocus","selector","xpath","pruneHistory","has","push","timestamp","shift","rect","getBoundingClientRect","x","left","y","top","detectClusterLoop","evaluateEfficiency","detectUTurn","filter","item","xs","map","p","ys","minX","min","maxX","minY","maxY","selectors","size","totalEvents","efficiency","h","len","A1","B1","C","B2","handleClick","hasPointer","getComputedStyle","cursor","e","hasPointerCursor","likelyInteractive","includes","hasAttribute","getAttribute","pendingSuccess","type","set","clicks","recentClicks","t","delete","registerMutation","handleTab","handleInputFocus","startValue","value","maxLenReached","typed","handleInputType","handleInputBlur","finalLen","startLen","charsAdded","TrapAlert","config","tenantId","collectorEndpoint","Error","behavioralTrace","maxTraceLength","behaviorEngine","lastTriggerTime","mediaRecorder","recordedChunks","domSnapshot","recognition","finalTranscript","focusHistory","escPressHistory","lastProductiveTime","startTime","activationThreshold","triggerLevel","notificationShown","ui","init","setupUI","attachListeners","startDecayTimer","startVelocityGateMonitor","timeSinceStart","timeSinceLastTrigger","globalStyle","head","skipLink","href","preventDefault","prepend","attachShadow","mode","handleReport","handleDismiss","handleStartRecording","bind","handleStopRecording","doc","cloneNode","root","documentElement","base","location","forEach","attr","querySelectorAll","el","val","startsWith","URL","allRealElements","allCloneElements","realEl","cloneEl","img","src","toDataURL","replaceWith","scrollLeft","outerHTML","captureDOMSnapshot","screenStream","navigator","mediaDevices","getDisplayMedia","video","combinedStream","audioStream","getUserMedia","tracks","getVideoTracks","getAudioTracks","MediaStream","mimeType","MediaRecorder","ondataavailable","event","data","onstop","finalizeRecording","getTracks","track","stop","start","setupSpeechRecognition","onended","error","alert","SpeechRecognition","webkitSpeechRecognition","continuous","interimResults","lang","onresult","interimTranscript","resultIndex","results","transcript","isFinal","onerror","onend","videoBlob","Blob","formData","FormData","append","JSON","stringify","getBrowserMetadata","fetch","method","ok","handleFocusIn","handleFocusOut","handleKeyDown","handleInput","handleShortcut","observer","MutationObserver","handleMutations","observe","childList","subtree","attributes","attributeFilter","hidden","mutations","mutation","addedNodes","node","checkErrorNode","target","role","ariaLive","addToTrace","checkThreshold","key","handleEscapePress","markProductiveBehavior","altKey","detail","url","firstLimit","secondLimit","notifyUser","dispatchReport","payload","toISOString","context","captureContext","metadata","sendBeacon","blob","fallbackFetch","headers","keepalive","activeElement","pageTitle","title","scrollPosition","scrollX","scrollY","userAgent","screenSize","width","screen","height","viewportSize","innerWidth","innerHeight","language","platform"],"mappings":"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"}